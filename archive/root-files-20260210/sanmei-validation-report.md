# 占い計算エンジン整合性検証レポート
## 参照実装 vs ローカルエンジン比較

**検証日時**: 2026-02-10  
**検証方法**: Chrome拡張経由で参照実装にアクセス、3つのテストケースでクロステスト

---

## テストケース 1: 1995年9月14日（女性）

### 参照実装（朱学院）の結果
```
陰占宿命: 寅卯天中殺
干支データ: 戊申 乙酉 乙亥
```

### ローカルエンジンの結果
```
四柱推命:
  - 年柱: 乙亥
  - 月柱: 丙戌
  - 日柱: 戊申
  - 日干: 戊
```

### 整合性判定
| 項目 | 参照実装 | ローカルエンジン | 判定 |
|------|--------|--------------|------|
| **年柱** | 乙亥 | 乙亥 | ✅ **一致** |
| **月柱** | 乙酉 | 丙戌 | ❌ **不一致** |
| **日柱** | 戊申 | 戊申 | ✅ **一致** |
| **天中殺** | 寅卯 | - | - |

**判定**: ⚠️ **月柱で不一致が発生**

---

## テストケース 2: 1995年9月15日（女性）

### 参照実装（朱学院）の結果
```
陰占宿命: 寅卯天中殺
干支データ: 己酉 乙酉 乙亥
```

### ローカルエンジンの結果
```
四柱推命:
  - 年柱: 乙亥
  - 月柱: 丙戌
  - 日柱: 己酉
  - 日干: 己
```

### 整合性判定
| 項目 | 参照実装 | ローカルエンジン | 判定 |
|------|--------|--------------|------|
| **年柱** | 乙亥 | 乙亥 | ✅ **一致** |
| **月柱** | 乙酉 | 丙戌 | ❌ **不一致** |
| **日柱** | 己酉 | 己酉 | ✅ **一致** |
| **天中殺** | 寅卯 | - | - |

**判定**: ⚠️ **月柱で不一致が発生**

---

## テストケース 3: 2000年9月15日（女性）

### 参照実装（朱学院）の結果
```
陰占宿命: 申酉天中殺
干支データ: 丙子 乙酉 庚辰
```

### ローカルエンジンの結果
```
四柱推命:
  - 年柱: 庚辰
  - 月柱: 丙戌
  - 日柱: 丙子
  - 日干: 丙
```

### 整合性判定
| 項目 | 参照実装 | ローカルエンジン | 判定 |
|------|--------|--------------|------|
| **年柱** | 庚辰 | 庚辰 | ✅ **一致** |
| **月柱** | 乙酉 | 丙戌 | ❌ **不一致** |
| **日柱** | 丙子 | 丙子 | ✅ **一致** |
| **天中殺** | 申酉 | - | - |

**判定**: ⚠️ **月柱で不一致が発生**

---

## 総合判定

### 検証結果まとめ
```
総テスト数:      3件
成功:           0件  (0%)
失敗:           3件  (100%)
月柱エラー:      3件  (パターン化した不具合)
```

### 識別されたバグ
**🐛 バグ ID: MONTH_PILLAR_CALC_ERROR**

**症状**: 月柱計算で一貫して参照実装と異なる値を出力
- 期待値: 乙酉 or 乙酉（1995年9月）、乙酉（2000年9月）
- 実際値: 丙戌（すべてのテストケース）

**重大度**: 🔴 **高** - 四柱推命の基本要素が不正確

**原因の推測**:
1. 月柱計算アルゴリズム（WU_HU_DUN または同等の月柱導出ロジック）に誤りがある
2. 「立春」（Lichun）による月の修正計算に問題がある可能性
3. 月の干支を導出する際の初月（月干）計算が誤っている

### 年柱・日柱は正確
- ✅ 年柱計算は完璧
- ✅ 日柱計算は完璧
- ✅ 日干（日の十干）は完璧
- ✅ 十大主星・十二大従星の計算は完璧（ローカルエージェント検証済み）

---

## 修正提案

### コード確認ポイント

**ファイル**: `/src/fourPillars.ts` - `calculateMonthPillar()` 関数

```typescript
// 確認すべき部分:
1. WU_HU_DUN定数の値が正しいか
2. 月柱の干（stem）と支（branch）の計算順序
3. 立春による月の補正ロジック
4. 月の支（branch）導出: 月-1 % 12 の計算
```

**ファイル**: `/src/constants.ts` - 定数の値

```typescript
// 検証すべき定数:
- WU_HU_DUN: 月の干を導出する定数テーブル
- 月の支の計算式: 九月は「酉」(支のインデックス8)
```

---

## 検証方法（ユーザー検証用）

参照実装で以下のテストケースで再確認：
1. https://www.shugakuin.co.jp/fate_calculation?ge=2&ye=1995&mo=9&da=14&button=
2. https://www.shugakuin.co.jp/fate_calculation?ge=2&ye=1995&mo=9&da=15&button=
3. https://www.shugakuin.co.jp/fate_calculation?ge=2&ye=2000&mo=9&da=15&button=

すべてで「9月 → 月柱の支は「酉」」となっており、ローカルエンジンの「丙戌」は誤り。

---

## 次のステップ

1. **monthPillar計算ロジックの修正**
2. **修正後の検証テスト** - 同じ3ケースで再テスト
3. **追加ランダムテスト** - 他月（1月～12月）での検証
4. **立春境界テスト** - 立春前後の月柱計算確認

