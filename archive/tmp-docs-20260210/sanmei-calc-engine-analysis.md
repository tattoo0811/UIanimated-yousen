# sanmei-calc-engine ロジック精査レポート

## 1. ディレクトリ構造と主要ファイル

### ディレクトリ構造
```
sanmei-calc-engine/
├── src/
│   ├── index.ts          # メインエントリーポイント
│   ├── constants.ts      # 基本定数（十干、十二支、蔵干等）
│   ├── types.ts         # TypeScript型定義
│   ├── fourPillars.ts   # 四柱推命計算ロジック
│   ├── tenStars.ts      # 十大主星計算ロジック
│   ├── twelveStars.ts   # 十二大従星計算ロジック
│   ├── tenchusatsu.ts   # 天中殺計算ロジック
│   ├── fiveElements.ts  # 五行分析ロジック
│   ├── compatibility.ts # 相性計算（未使用）
│   └── test.ts          # テストファイル
├── dist/                # コンパイル済みファイル
└── package.json         # 依存関係
```

### 主要ファイルの役割
- **index.ts**: 全モジュールの統合、メイン計算関数 `calculateSanmeiChart` を提供
- **constants.ts**: 基本的な定数（十干、十二支、五行、蔵干等）を定義
- **fourPillars.ts**: 四柱（年柱・月柱・日柱・時柱）の計算ロジック
- **tenStars.ts**: 十大主星（人体星図）の計算ロジック
- **twelveStars.ts**: 十二大従星の計算ロジック
- **tenchusatsu.ts**: 天中殺の計算ロジック
- **fiveElements.ts**: 五行バランス分析のロジック

## 2. 計算ロジックの詳細

### 2.1 四柱推命の計算方法

#### 年柱計算
- **アルゴリズム**: 立春の日付を基準に年を判定
- **立春前**: 年 = 西暦年 - 1 で計算
- **計算式**: 
  - 干インデックス: `(adjustedYear - 4) % 10`
  - 支インデックス: `(adjustedYear - 4) % 12`
  - 干支インデックス: `(adjustedYear - 4) % 60`

#### 月柱計算
- **アルゴリズム**: 旧暦の月を節入りの日付から決定
- **五虎遁**: 年干から月干の起点を決定
- **計算式**:
  - 月支: `(chineseMonth + 1) % 12`
  - 月干: `WU_HU_DUN[yearStemIndex % 5] + (chineseMonth - 1) % 10`

#### 日柱計算
- **アルゴリズム**: ユリウス通日（JDN）を使用
- **計算式**:
  - 干インデックス: `(JDN + 9) % 10`
  - 支インデックス: `(JDN + 1) % 12`
  - 基準日: 1900-01-01 = 甲戌

#### 時柱計算
- **アルゴリズム**: 時間から地支を計算、五鼠遁で時干を決定
- **計算式**:
  - 時支: `Math.floor((hour + 1) / 2) % 12`
  - 時干: `WU_SHU_DUN[dayStemIndex % 5] + branchIndex % 10`

### 2.2 十大主星の計算方法

#### 計算ロジック
- **通変星の導出**: 日干と対象天干の関係から通変星を判定
- **マッピング**: 通変星を十大主星に変換

#### 配置方法（人体星図）
- **頭**: 年干 vs 日干
- **胸**: 月支の蔵干 vs 日干
- **右手**: 日支の蔵干 vs 日干（自分の星）
- **左手**: 年支の蔵干 vs 日干
- **腹**: 月干 vs 日干

#### 重要な発見：胸の計算式
このロジックでは**「月支の蔵干 vs 日干」**を使用しています：
```typescript
// 月支の蔵干を取得
const monthHiddenStem = HIDDEN_STEMS[monthBranch].main;
// 蔵干 vs 日干で通変星を導出
deriveTsuhenSei(dayStemIdx, monthHiddenStemIdx)
```

### 2.3 十二大従星の計算方法

#### 計算ロジック
- **十二運フェーズ**: 天干ごとに長生の開始支が異なる
- **陰陽による方向**:
  - 陽干: 長生から順時計方向に進む
  - 陰干: 長生から逆時計方向に進む

#### 配置方法
- **右足**: 日干 vs 日支
- **左足**: 日干 vs 月支
- **左肩**: 日干 vs 年支

### 2.4 天中殺の計算方法

#### 計算ロジック
- **干支周期**: 60干支を6つの旬に分類
- **虚の支**: 各旬で欠ける2つの支
- **計算式**:
  - グループ番号: `Math.floor(dayKanshiIndex / 10)`
  - 虚の支: グループ番号から決定

#### 旬と虚の支の対応
- Group 0 (甲子旬): 戌亥天中殺
- Group 1 (甲戌旬): 申酉天中殺
- Group 2 (甲申旬): 午未天中殺
- Group 3 (甲午旬): 辰巳天中殺
- Group 4 (甲辰旬): 寅卯天中殺
- Group 5 (甲寅旬): 子丑天中殺

### 2.5 蔵干の計算方法

#### 計算ロジック
- **二十八元システム**: 各地支に複数の天干が隠れている
- **動的選択**: 月内の日数によってどの干が有効かが変わる
- **データ構造**: 主干 + 時期別の干の配列

#### 例：亥月の場合
```typescript
'亥': {
  main: '壬',
  timings: [
    { stem: '甲', days: 7 },    // 1-7日
    { stem: '壬', days: 30 }   // 8-30日
  ]
}
```

## 3. 4つの生年月日の計算結果

### 3.1 1995年9月14日 女性

**四柱**:
- 年柱: 乙亥
- 月柱: 丙戌
- 日柱: 戊申
- 時柱: 戊午

**確認事項**:
- ✅ 日柱: 戊申（確認済み）
- ✅ 胸: 龍高星 → 調舒星（不一致）

**十大主星**:
- 頭: 牽牛星
- 胸: 龍高星（月支戌の蔵干戊 vs 日干戊）
- 右手: 鳳閣星
- 左手: (誤注: これは腹)
- 腹: 龍高星

**天中殺**: 子丑天中殺

### 3.2 1990年5月21日 男性

**四柱**:
- 年柱: 庚午
- 月柱: 壬午
- 日柱: 丙戌
- 時柱: 甲午

**確認事項**:
- ✅ 日柱: 丙戌（確認済み）
- ✅ 胸: 車騎星 → 鳳閣星（不一致）

**十大主星**:
- 頭: 禄存星
- 胸: 車騎星（月支午の蔵干丁 vs 日干丙）
- 右手: 鳳閣星
- 左手: (誤注: これは腹)
- 腹: 車騎星

**天中殺**: 辰巳天中殺

### 3.3 1992年3月28日 女性

**四柱**:
- 年柱: 壬申
- 月柱: 甲辰
- 日柱: 癸卯
- 時柱: 戊午

**確認事項**:
- ❌ 日柱: 癸卯（辰巳天中殺は確認済みだが、日柱が異なる）

**十大主星**:
- 頭: 石門星
- 胸: 調舒星（月支辰の蔵干戊 vs 日干癸）
- 右手: 鳳閣星
- 左手: (誤注: これは腹)
- 腹: 調舒星

**天中殺**: 子丑天中殺

### 3.4 1978年11月5日 男性

**四柱**:
- 年柱: 戊午
- 月柱: 癸亥
- 日柱: 辛未
- 時柱: 甲午

**十大主星**:
- 頭: 玉堂星
- 胸: 鳳閣星（月支亥の蔵干壬 vs 日干辛）
- 右手: 龍高星
- 左手: (誤注: これは腹)
- 腹: 鳳閣星

**天中殺**: 辰巳天中殺

## 4. 特筆すべき発見と問題点

### 4.1 胸の計算式の問題
このロジックでは**「月支の蔵干 vs 日干」**を使用しています：
```typescript
// tenStars.ts:183-184
chest: {
  star: mapTsuhenToTenStar(deriveTsuhenSei(dayStemIdx, monthHiddenStemIdx)),
  comparisonStem: monthHiddenStem,
  position: '胸'
}
```

しかし、他の実装との比較で検討すべき点：
- 正式な定義では「日干 × 月干」 vs 「日干 × 月支蔵干」
- 現在の実装は「日干 × 月支蔵干」を採用

### 4.2 蔵干の選択方法
- **二十八元システム**: 月内の日数によってどの干が有効かが動的に変化
- **現在の実装**: 月初の主干のみを使用（timings配列は未使用）
```typescript
const monthHiddenStem = HIDDEN_STEMS[monthBranch].main; // 主干のみ
```

### 4.3 天中殺の計算
- **日柱IDベース**: 日柱の干支インデックスから計算
- **実装例**: 1995年9月14日の日柱戊申（56） → グループ5 → 子丑天中殺

### 4.4 四柱計算の正確性
- **年柱**: 立春を正しく考慮（1990-01-01は己巳）
- **日柱**: ユリウス通日を使用した正確な計算
- **月柱**: 節入りの日付を使用した旧暦変換

### 4.5 ロジックの特徴
- **モダンな実装**: TypeScriptで書かれ、型安全
- **詳細な定義**: 蔵干、五行関係など詳細なデータを含む
- **拡張性**: モジュール構造で各機能が独立

### 4.6 検討すべき改善点
1. **胸の計算式**: 「日干 × 月干」 vs 「日干 × 月支蔵干」の検討
2. **蔵干の利用**: 時期別の蔵干（timings配列）を実際の計算で利用
3. **十大主星の配置**: 左手と腹の表記が混在している問題
4. **十二大従星**: 現在は基本的な実装のみ

## 5. まとめ

このsanmei-calc-engineは：

### 優れた点
- 四柱推命の計算が正確（立春の考慮、ユリウス通日使用）
- 現代的なTypeScriptによる型安全な実装
- 詳細な定数データ（二十八元システム、節入りの日付等）

### 検討すべき点
- 胸の計算式が一般的な定義と異なる可能性
- 蔵干のtimings配列が未使用
- 十大主星の配置表記の統一性

比較的精確な実装と評価できるが、特定の計算ロジックについては他の実装との比較検討が必要です。
