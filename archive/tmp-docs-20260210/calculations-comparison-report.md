# 命式計算ロジック比較検証レポート

## 概要

4つのテストケースに対して、3つの計算ロジックを比較検証した結果を報告する。

- **ロジックA**: mobile版（二十八元に基づく動的蔵干）
- **ロジックB**: yinyang-app版（固定蔵干）
- **ユーザー確認値**: 外部の占いサイト等で確認した値

## テストケース

| ID | 生年月日 | 性別 | ユーザー確認値 |
|----|----------|------|----------------|
| 1 | 1985-07-15 | 男性 | なし |
| 2 | 1992-03-28 | 女性 | 天中殺: 辰巳天中殺 |
| 3 | 1978-11-05 | 男性 | なし |
| 4 | 1995-09-12 | 女性 | 右手: 調舒星 |

---

## テストケース1: 1985-07-15 男性

### 四柱推命

| 柱 | 干支 | ID |
|----|------|----|
| 年柱 | 乙丑 | 2 |
| 月柱 | 癸未 | 20 |
| 日柱 | 乙卯 | 52 |
| 時柱 | 壬午 | 19 |

### 天中殺

- **ロジックA**: 子丑天中殺
- **ユーザー確認値**: なし

### 十大主星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 頭 | 貫索星 | 貫索星 | - |
| 右手 | 貫索星 | 貫索星 | - |
| 胸 | 鳳閣星 | 鳳閣星 | - |
| 左手 | 龍高星 | 車騎星 | **あり** |
| 腹 | 龍高星 | 龍高星 | - |

**注**: 左手に差異。ロジックAは年支（丑）の蔵干が「辛」、ロジックBも「辛」だが、結果が異なる。

### 十二大従星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 左肩 | 天堂星 (8点) | 天庫星 (5点) | **あり** |
| 右足 | 天禄星 (11点) | 天貴星 (9点) | **あり** |
| 左足 | 天印星 (6点) | 天馳星 (1点) | **あり** |

**注**: 十二大従星に大きな差異。エネルギー点数表の計算に問題がある可能性。

---

## テストケース2: 1992-03-28 女性

### 四柱推命

| 柱 | 干支 | ID |
|----|------|----|
| 年柱 | 壬申 | 9 |
| 月柱 | 癸卯 | 40 |
| 日柱 | 癸卯 | 40 |
| 時柱 | 戊午 | 55 |

### 天中殺

- **ロジックA**: 辰巳天中殺
- **ユーザー確認値**: 辰巳天中殺
- **照合結果**: ✓ 一致

### 十大主星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 頭 | 石門星 | 石門星 | - |
| 右手 | 鳳閣星 | 鳳閣星 | - |
| 胸 | 鳳閣星 | 鳳閣星 | - |
| 左手 | 玉堂星 | 牽牛星 | **あり** |
| 腹 | 貫索星 | 貫索星 | - |

**注**: 左手に差異。年支（申）の蔵干がロジックAは「戊」、ロジックBも「戊」だが、結果が異なる。

### 十二大従星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 左肩 | 天極星 (2点) | 天極星 (2点) | - |
| 右足 | 天貴星 (9点) | 天報星 (3点) | **あり** |
| 左足 | 天貴星 (9点) | 天報星 (3点) | **あり** |

**注**: 右足と左足に差異。月支と日支が同じ（卯）のため、両方の結果が一致すべきだが、ロジックBで異なっている。

---

## テストケース3: 1978-11-05 男性

### 四柱推命

| 柱 | 干支 | ID |
|----|------|----|
| 年柱 | 戊午 | 55 |
| 月柱 | 壬戌 | 59 |
| 日柱 | 辛未 | 8 |
| 時柱 | 甲午 | 31 |

### 天中殺

- **ロジックA**: 戌亥天中殺
- **ユーザー確認値**: なし

### 十大主星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 頭 | 玉堂星 | 玉堂星 | - |
| 右手 | 龍高星 | 車騎星 | **あり** |
| 胸 | 玉堂星 | 車騎星 | **あり** |
| 左手 | 車騎星 | 車騎星 | - |
| 腹 | 調舒星 | 調舒星 | - |

**注**: 右手と胸に差異。
- 右手: 日支（未）の蔵干がロジックAは「己」、ロジックBは「丁」
- 胸: 月支（戌）の蔵干がロジックAは「戊」、ロジックBは「丁」

### 十二大従星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 左肩 | 天胡星 (4点) | 天禄星 (11点) | **あり** |
| 右足 | 天堂星 (8点) | 天極星 (2点) | **あり** |
| 左足 | 天南星 (10点) | 天将星 (12点) | **あり** |

**注**: すべての十二大従星に差異。

---

## テストケース4: 1995-09-12 女性

### 四柱推命

| 柱 | 干支 | ID |
|----|------|----|
| 年柱 | 乙亥 | 12 |
| 月柱 | 乙酉 | 22 |
| 日柱 | 丙午 | 43 |
| 時柱 | 甲午 | 31 |

### 天中殺

- **ロジックA**: 寅卯天中殺
- **ユーザー確認値**: なし

### 十大主星比較

| 位置 | ロジックA | ロジックB | 差異 | ユーザー確認値 |
|------|----------|----------|------|----------------|
| 頭 | 玉堂星 | 玉堂星 | - | - |
| 右手 | 貫索星 | 石門星 | **あり** | 調舒星 |
| 胸 | 司禄星 | 司禄星 | - | - |
| 左手 | 龍高星 | 龍高星 | - | - |
| 腹 | 玉堂星 | 玉堂星 | - | - |

**重要な発見**:
- **ユーザー確認値**: 右手は「調舒星」
- **ロジックA**: 右手は「貫索星」
- **ロジックB**: 右手は「石門星」
- **結論**: どちらのロジックもユーザー確認値と一致しない

右手の計算: 日干（丙）× 日支蔵干
- 日干: 丙（火・陽）
- 日支: 午
- 日支蔵干:
  - ロジックA: 己（土・陰）- 二十八元の節入りからの日数に基づく
  - ロジックB: 丁（火・陰）- 固定蔵干
- 調舒星になるには: 日干 × 日支蔵干 = 洩気（異五行・異陰陽）

**調舒星の条件**:
- 日干: 丙（火・陽）
- 日支蔵干: 水（陰）または 金（陰）
- 現在の蔵干:
  - ロジックA: 己（土・陰）→ 結果: 貫索星（比和）
  - ロジックB: 丁（火・陰）→ 結果: 石門星（比和）

### 十二大従星比較

| 位置 | ロジックA | ロジックB | 差異 |
|------|----------|----------|------|
| 左肩 | 天馳星 (1点) | 天報星 (3点) | **あり** |
| 右足 | 天将星 (12点) | 天恍星 (7点) | **あり** |
| 左足 | 天極星 (2点) | 天将星 (12点) | **あり** |

**注**: すべての十二大従星に差異。

---

## 差異分析

### 1. 天中殺の計算

**結論**: ロジックAの天中殺計算は正しい。

- テストケース2でユーザー確認値（辰巳天中殺）と一致した。
- 計算式: `天中殺タイプ = TENCHUSATSU_TYPES[Math.floor((日柱ID - 1) / 10)]`

### 2. 十大主星の計算

**主要な差異要因**: 蔵干の選択方法

| 地支 | ロジックA（二十八元） | ロジックB（固定） |
|------|---------------------|------------------|
| 丑 | 辛 | 辛 |
| 申 | 戊（動的） | 戊 |
| 未 | 己（動的） | 丁 |
| 戌 | 戊（動的） | 丁 |
| 午 | 己（動的） | 丁 |

**問題点**:
1. **二十八元の実装**: mobile版の二十八元データに誤りがある可能性。
2. **節入りからの日数計算**: `getDaysFromSolarTerm()` 関数が正確か検証が必要。
3. **固定蔵干の正確性**: yinyang-app版の固定蔵干配列が正しいか確認が必要。

### 3. 十二大従星の計算

**主要な差異要因**: エネルギー点数表（ENERGY_TABLE）の不一致

mobile版とyinyang-app版でENERGY_TABLEの値が異なる:

- **庚行**: mobile版 `[4,6,1,9,5,2,8,12,11,10,3,7]` vs yinyang-app版 `[4,6,1,9,5,2,8,12,11,10,7,3]`
  - 10番目と11番目が入れ替わっている

この不一致が、十二大従星の計算結果に大きな影響を与えている。

### 4. テストケース4の「調舒星」問題

**ユーザー確認値**: 右手は「調舒星」

**調舒星の条件**:
- 日干: 丙（火・陽）
- 日支蔵干: 水（陰）または 金（陰）
- 関係: 洩気（異五行・異陰陽）

**現在の結果**:
- ロジックA: 日支蔵干 = 己（土・陰）→ 貫索星（比和）
- ロジックB: 日支蔵干 = 丁（火・陰）→ 石門星（比和）

**推測**:
- ユーザー確認値が正しい場合、日支（午）の蔵干は「壬（水・陽）」または「癸（水・陰）」である必要がある。
- しかし、午の蔵干は伝統的に「丁・己」であり、水はない。
- 可能性:
  1. ユーザー確認値に誤りがある
  2. 別の計算ロジックが使用されている
  3. 占いサイトによって計算方法が異なる

---

## 推奨事項

### 1. 即時の修正が必要

- **エネルギー点数表（ENERGY_TABLE）**: mobile版とyinyang-app版で不一致があるため、どちらが正しいか確認し、統一する。
- **十二大従星計算**: ロジックAの十二大従星計算を確認する。特にテストケース1で同じ日支（卯）に対して異なる結果になっている問題。

### 2. 検証が必要

- **二十八元データ**: 節入りからの日数に基づく蔵干選択が正しいか、専門書や信頼できる占いサイトと照合する。
- **固定蔵干配列**: yinyang-app版の固定蔵干が正しいか確認する。
- **テストケース4の調舒星**: ユーザー確認値の詳細を確認し、どのような条件下で調舒星になるか調査する。

### 3. 今後の対応

1. **信頼できる情報源の確認**: 三才占学の専門書や、複数の占いサイトで計算結果を照合する。
2. **テストケースの拡充**: より多くのテストケースで計算結果を検証する。
3. **ドキュメントの作成**: AGENTS.mdに正しい計算手順を記録する。

---

## 結論

1. **天中殺計算**: ロジックAは正しい（テストケース2で確認）。
2. **十大主星計算**: 蔵干の選択方法に違いがあり、二十八元の実装に問題がある可能性。
3. **十二大従星計算**: エネルギー点数表の不一致が大きな差異を引き起こしている。
4. **テストケース4**: ユーザー確認値（調舒星）とどちらのロジックも一致しない。追加調査が必要。

**最優先事項**:
1. エネルギー点数表の統一
2. 二十八元データの検証
3. テストケース4の調査
