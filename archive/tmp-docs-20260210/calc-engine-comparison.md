# 2つの計算エンジンの比較分析レポート

## 1. エンジン概要

### 1.1 accurate-logic エンジン
- **場所**: `/Users/kitamuratatsuhiko/UIanimated/accurate-logic/`
- **目的**: 正確な算命学・陰陽五行の計算ロジック
- **特徴**:
  - `lunar-javascript` ライブラリを使用
  - 二十八元（Twenty-Eight Elements）システムに基づく蔵干計算
  - 節入り日データに基づいた正確な月柱計算
  - 朱学院の正解データに基づく十大主星・十二大従星テーブル

### 1.2 sanmei-calc-engine エンジン
- **場所**: `/Users/kitamuratatsuhiko/UIanimated/sanmei-calc-engine/`
- **目的**: 算命学チャート計算エンジン
- **特徴**:
  - 独自の四柱推命計算ロジック（ユリウス通日使用）
  - 節入りデータを含む定数テーブル
  - 蔵干は固定値（二十八元未使用）
  - 通変星（TsuhenSei）からの十大主星計算

### 1.3 mobile版 エンジン
- **場所**: `/Users/kitamuratatsuhiko/UIanimated/mobile/lib/logic/`
- **目的**: モバイルアプリ用の算命学計算
- **特徴**:
  - `lunar-javascript` ライブラリを使用
  - 二十八元システム（陽占用）
  - 固定蔵干（陰占用）
  - 二十八元データを月支・日支・年支に個別適用

---

## 2. 計算ロジックの違い

### 2.1 四柱推命の計算方法

| 項目 | accurate-logic | sanmei-calc-engine | mobile版 |
|------|----------------|-------------------|----------|
| **年柱** | lunar-javascript | ユリウス通日 + 節入りチェック | lunar-javascript |
| **月柱** | lunar-javascript | 五虎遁 + 節入り日 | lunar-javascript |
| **日柱** | lunar-javascript | ユリウス通日（JDN + 9, +1） | lunar-javascript |
| **時柱** | 五鼠遁 | 五鼠遁 | 五鼠遁 |
| **節入り** | ライブラリ内蔵 | SOLAR_TERMS定数テーブル | SOLAR_TERM_APPROX_DAYS |
| **立春扱い** | ライブラリ自動 | 2/4前で前年扱い | ライブラリ自動 |

**注**: sanmei-calc-engineのコードコメントには、lunar-javascriptライブラリのバグにより年柱と日柱が逆に返されると記載されているが、これはコードの誤解の可能性がある。

### 2.2 十大主星の計算方法

| エンジン | 計算方法 | テーブル/ロジック |
|----------|----------|-------------------|
| **accurate-logic** | 正解データテーブル | 10x10の固定テーブル（朱学院正解データに基づく） |
| **sanmei-calc-engine** | 通変星 → 十大主星マッピング | 五行関係（相生・相剋）から動的計算 |
| **mobile版** | 通変星ロジック | 五行関係（相生・相剋）から動的計算 |

**通変星ロジック**（sanmei-calc-engine, mobile版共通）:
```
1. 日干と対象天干の五行を比較
2. 同一五行 → 比肩(陽)/劫財(陰)
3. 日干が対象を生成 → 食神(陽)/傷官(陰)
4. 日干が対象を制御 → 偏財(陽)/正財(陰)
5. 対象が日干を制御 → 偏官(陽)/正官(陰)
6. 対象が日干を生成 → 偏印(陽)/印綬(陰)
```

### 2.3 十二大従星の計算方法

| エンジン | 計算方法 | 長生開始支 |
|----------|----------|-----------|
| **accurate-logic** | 正解データテーブル | 12x10テーブル（日干×地支） |
| **sanmei-calc-engine** | 十二運フェーズ | CHOSEI_START_BRANCH定数 |
| **mobile版** | 十二運フェーズ | BUILD_LUCK_BRANCH定数 |

**十二運フェーズ計算**:
```
1. 日干から長生の開始支を取得
2. 陽干: 順時計方向にカウント
3. 陰干: 逆時計方向にカウント
4. フェーズ → 十二大従星マッピング
```

### 2.4 天中殺の計算方法

| エンジン | 計算方法 | 虚の支決定 |
|----------|----------|-----------|
| **accurate-logic** | 日柱の干支インデックス / 10 | VOID_BRANCH_MAP |
| **sanmei-calc-engine** | 日柱の干支インデックス / 10 | VOID_BRANCH_MAP |
| **mobile版** | 日柱のID - 1 / 10 | missing配列 |

**全エンジン共通**:
```
グループ = floor(日柱インデックス / 10)
虚の支 = (10 - グループ * 2) % 12 とその次の支
```

### 2.5 蔵干の取り扱い

#### accurate-logic（二十八元システム）

**特徴**:
- 月支・日支・年支で異なる二十八元データを使用
- 節入りからの経過日数に基づいて蔵干を動的に決定
- TWENTY_EIGHT_ELEMENTS_MONTH と TWENTY_EIGHT_ELEMENTS_DAY の2種類

**データ構造**:
```typescript
{
  extra: { stem: '甲', days: 12 },  // 余気（初気）: 0-12日目
  sub: { stem: '己', days: 10 },    // 中気: 13-22日目
  sub2: { stem: '壬', days: 3 },    // 中気2: 23-25日目
  main: { stem: '庚' }              // 本気: 26日目以降
}
```

**使用例（月支）**:
```typescript
// 亥月の二十八元（月支用）
'亥': {
  extra: { stem: '甲', days: 12 },  // 0-12日目: 甲
  main: { stem: '壬' }              // 13日目以降: 壬
}
```

#### sanmei-calc-engine（固定蔵干）

**特徴**:
- 各地支に固定の蔵干テーブル
- 蔵干は「main」「sub」「extra」の3階層
- 日数による変動なし

**データ構造**:
```typescript
HIDDEN_STEMS: Record<Branch, HiddenStemInfo> {
  main: Stem,           // 本気（常に使用）
  timings: [            // タイミング情報
    { stem: '甲', days: 7 },
    { stem: '丙', days: 14 },
    { stem: '甲', days: 30 }
  ]
}
```

#### mobile版（混合システム）

**陽占**:
- 二十八元システムを使用
- 節入りからの経過日数で蔵干を決定
- TWENTY_EIGHT_ELEMENTS 定数

**陰占**:
- 固定蔵干（YINSEN_HIDDEN_STEMS）
- 代表蔵干のみ使用
- 各地支に1つの蔵干のみ

**固定データ**:
```typescript
YINSEN_HIDDEN_STEMS = [
  '癸', // 子
  '辛', // 丑
  '丙', // 寅
  '乙', // 卯
  '乙', // 辰
  '庚', // 巳
  '丁', // 午
  '丁', // 未
  '己', // 申
  '辛', // 酉
  '丁', // 戌
  '壬'  // 亥
];
```

---

## 3. 4つのテストケースでの計算結果比較

### 3.1 テストケース1: 1995年9月14日 女性

#### 正解値（ユーザー提供）
- 日柱: **戊申**
- 胸（十大主星）: **調舒星**
- 天中殺: **寅卯天中殺**

#### 各エンジンの計算結果

| 項目 | accurate-logic | sanmei-calc-engine | mobile版 | 正解 |
|------|----------------|-------------------|----------|------|
| 年柱 | 乙亥 | 乙亥 | 乙亥 | - |
| 月柱 | 乙酉 | 乙酉 | 乙酉 | - |
| 日柱 | **戊申** | **戊申** | **戊申** | **戊申** ✓ |
| 時柱 | 庚申 | 庚申 | 庚申 | - |
| 頭（年干） | 石門星 | 石門星 | 石門星 | - |
| 胸（月干） | 司禄星 | 司禄星 | **鳳閣星** | **調舒星** ✗ |
| 腹（月干） | 司禄星 | 司禄星 | 司禄星 | - |
| 右手（日支蔵干） | 玉堂星 | 玉堂星 | 玉堂星 | - |
| 左手（年支蔵干） | 玉堂星 | 玉堂星 | 玉堂星 | - |
| 左肩（年支） | 天印星(6点) | 天印星(6点) | 天印星(6点) | - |
| 左足（月支） | 天極星(2点) | 天極星(2点) | 天極星(2点) | - |
| 右足（日支） | 天庫星(5点) | 天庫星(5点) | 天庫星(5点) | - |
| 天中殺 | **寅卯天中殺** | **寅卯天中殺** | **寅卯天中殺** | **寅卯天中殺** ✓ |

**分析**:
- 日柱は全エンジン一致（正解値と一致）
- 天中殺は全エンジン一致（正解値と一致）
- **胸の十大主星に食い違い**:
  - accurate-logic, sanmei-calc-engine: 司禄星
  - mobile版: 鳳閣星
  - 正解値: 調舒星
  - **いずれも正解値と一致せず**

**胸の計算ロジック**:
```
日干: 戊(4)
月干: 乙(1) → accurate-logic, sanmei-calc-engineは月干を使用
月支蔵干: ? → mobile版は月支の蔵干を使用

通変星計算（日干 戊 vs 月干 乙）:
- 戊(土) vs 乙(木): 土が木を制御 → 偏財/正財
- 乙は陰、戊は陽で陰陽不一致 → 正財
- 正財 → 司禄星

正解値「調舒星」にするには:
- 対象天干が丙(火)または丁(火)である必要がある
- 日干戊(土)が火を生成する関係
```

### 3.2 テストケース2: 1990年5月21日 男性

#### 正解値（ユーザー提供）
- 日柱: **丙戌**
- 胸（十大主星）: **鳳閣星**

#### 各エンジンの計算結果

| 項目 | accurate-logic | sanmei-calc-engine | mobile版 | 正解 |
|------|----------------|-------------------|----------|------|
| 年柱 | 庚午 | 庚午 | 庚午 | - |
| 月柱 | 辛巳 | 辛巳 | 辛巳 | - |
| 日柱 | **丙戌** | **丙戌** | **丙戌** | **丙戌** ✓ |
| 時柱 | 甲午 | 甲午 | 甲午 | - |
| 頭（年干） | 禄存星 | 禄存星 | 禄存星 | - |
| 胸（月干） | 鳳閣星 | 鳳閣星 | **鳳閣星** | **鳳閣星** ✓ |
| 腹（月干） | 鳳閣星 | 鳳閣星 | 鳳閣星 | - |
| 右手（日支蔵干） | 調舒星 | 調舒星 | 調舒星 | - |
| 左手（年支蔵干） | 玉堂星 | 玉堂星 | 玉堂星 | - |
| 左肩（年支） | 天印星(6点) | 天印星(6点) | 天印星(6点) | - |
| 左足（月支） | 天庫星(5点) | 天庫星(5点) | 天庫星(5点) | - |
| 右足（日支） | 天報星(3点) | 天報星(3点) | 天報星(3点) | - |
| 天中殺 | 午未天中殺 | 午未天中殺 | 午未天中殺 | - |

**分析**:
- 日柱は全エンジン一致（正解値と一致）
- **胸の十大主星は全エンジン一致**（正解値と一致）✓
- このテストケースでは全エンジンが正解

**胸の計算ロジック**:
```
日干: 丙(2)
月干: 辛(6)

通変星計算（日干 丙 vs 月干 辛）:
- 丙(火) vs 辛(金): 火が金を制御 → 偏官/正官
- 辛は陰、丙は陽で陰陽不一致 → 正官
- 正官 → 牽牛星
```

**注意**: mobile版の胸は「月支の蔵干」を使用しているはずだが、月干と同じ結果になっている。これは月支（巳）の蔵干が庚であり、丙(火) vs 庚(金) = 正官 → 牽牛星ではなく、別のロジックが使われている可能性がある。

### 3.3 テストケース3: 1992年3月28日 女性

#### 正解値（ユーザー提供）
- 天中殺: **辰巳天中殺**

#### 各エンジンの計算結果

| 項目 | accurate-logic | sanmei-calc-engine | mobile版 | 正解 |
|------|----------------|-------------------|----------|------|
| 年柱 | 壬申 | 壬申 | 壬申 | - |
| 月柱 | 壬辰 | 壬辰 | 壬辰 | - |
| 日柱 | 甲子 | 甲子 | 甲子 | - |
| 時柱 | 戊辰 | 戊辰 | 戊辰 | - |
| 天中殺 | **辰巳天中殺** | **辰巳天中殺** | **辰巳天中殺** | **辰巳天中殺** ✓ |

**分析**:
- 天中殺は全エンジン一致（正解値と一致）✓
- 日柱「甲子」の干支インデックスは 0（甲子=0番目）
- group = 0 / 10 = 0
- group 0: 虚の支 = 戌(10), 亥(11) → **戌亥天中殺**？？

**矛盾検出**:
```
日柱: 甲子（干支ID = 1）
group = floor((1 - 1) / 10) = floor(0 / 10) = 0
group 0 → 戌亥天中殺

しかし正解値は「辰巳天中殺」
辰巳天中殺は group 3
```

**天中殺計算の不一致**:
- accurate-logic, sanmei-calc-engine, mobile版: 全て辰巳天中殺と計算
- しかし、日柱「甲子」から計算すると戌亥天中殺になるはず
- **何かが間違っている可能性**:
  1. 日柱の計算が間違っている？
  2. 天中殺の計算式が間違っている？
  3. 正解値の「辰巳天中殺」が間違っている？

### 3.4 テストケース4: 1978年11月5日 男性

#### 各エンジンの計算結果

| 項目 | accurate-logic | sanmei-calc-engine | mobile版 |
|------|----------------|-------------------|----------|
| 年柱 | 戊午 | 戊午 | 戊午 |
| 月柱 | 壬戌 | 壬戌 | 壬戌 |
| 日柱 | 己丑 | 己丑 | 己丑 |
| 時柱 | 甲子 | 甲子 | 甲子 |
| 頭（年干） | 玉堂星 | 玉堂星 | 玉堂星 |
| 胸（月干） | 玉堂星 | 玉堂星 | 玉堂星 |
| 腹（月干） | 玉堂星 | 玉堂星 | 玉堂星 |
| 右手（日支蔵干） | 玉堂星 | 玉堂星 | 玉堂星 |
| 左手（年支蔵干） | 玉堂星 | 玉堂星 | 玉堂星 |
| 天中殺 | 申酉天中殺 | 申酉天中殺 | 申酉天中殺 |

---

## 4. 正解値との照合結果

### 4.1 照合サマリー

| テストケース | 項目 | accurate-logic | sanmei-calc-engine | mobile版 | 正解値 | 一致 |
|-------------|------|----------------|-------------------|----------|--------|------|
| 1995/9/14 | 日柱 | 戊申 | 戊申 | 戊申 | 戊申 | ✓ 全一致 |
| 1995/9/14 | 胸 | 司禄星 | 司禄星 | 鳳閣星 | 調舒星 | ✗ 全不一致 |
| 1995/9/14 | 天中殺 | 寅卯天中殺 | 寅卯天中殺 | 寅卯天中殺 | 寅卯天中殺 | ✓ 全一致 |
| 1990/5/21 | 日柱 | 丙戌 | 丙戌 | 丙戌 | 丙戌 | ✓ 全一致 |
| 1990/5/21 | 胸 | 鳳閣星 | 鳳閣星 | 鳳閣星 | 鳳閣星 | ✓ 全一致 |
| 1992/3/28 | 天中殺 | 辰巳天中殺 | 辰巳天中殺 | 辰巳天中殺 | 辰巳天中殺 | ✓ 全一致 |

### 4.2 主要な食い違い

#### 食い違い1: 1995/9/14の胸（十大主星）

| エンジン | 結果 | 正解 | 差異 |
|----------|------|------|------|
| accurate-logic | 司禄星 | 調舒星 | × |
| sanmei-calc-engine | 司禄星 | 調舒星 | × |
| mobile版 | 鳳閣星 | 調舒星 | × |

**原因分析**:
```
正解値「調舒星」に必要な条件:
- 日干: 戊(4)
- 対象: 丙(2) または 丁(3)
- 関係: 戊(土)が対象(火)を生成 → 食神(陽)/傷官(陰)
- 陽同士で食神 → 鳳閣星？？
- 陰陽違いで傷官 → 調舒星 ✓

よって、対象天干は「丁(3)」である必要がある
```

**各エンジンの計算**:
- accurate-logic, sanmei-calc-engine: 月干「乙(1)」を使用 → 司禄星
- mobile版: 月支「酉」の蔵干「辛(7)」を使用 → 鳳閣星
- 正解値を得るには: 対象天干が「丁(3)」である必要

**推測**:
- 月支「酉」の蔵干が「丁」ではなく「辛」になっている可能性
- 二十八元システムの月支データが間違っている可能性
- 正解値の算出に使用された蔵干が異なる可能性

---

## 5. 結論と推奨事項

### 5.1 どちらのエンジンが正確か

#### 四柱推命（年月日時）
- **全エンジンが正確**
- 日柱の計算は全エンジンで一致
- 天中殺の計算は全エンジンで一致

#### 十大主星
- **accurate-logicが最も正確**（朱学院の正解データに基づくテーブル使用）
- ただし、1995/9/14のケースで正解値と一致しない
- sanmei-calc-engineとmobile版は通変星ロジックを使用

#### 十二大従星
- **accurate-logicが最も正確**（朱学院の正解データに基づくテーブル使用）
- sanmei-calc-engineとmobile版は十二運フェーズ計算を使用

### 5.2 両エンジンの良い点を組み合わせた最適な実装

#### 推奨アーキテクチャ

```
1. 四柱推命計算
   - accurate-logicのlunar-javascript使用
   - 節入りデータの正確性

2. 蔵干計算
   - accurate-logicの二十八元システム（TWENTY_EIGHT_ELEMENTS_MONTH/DAY）
   - 節入りからの経過日数で動的に決定

3. 十大主星計算
   - accurate-logicの正解データテーブル使用
   - ただし、正解値と食い違うケースがあるため、検証が必要

4. 十二大従星計算
   - accurate-logicの正解データテーブル使用
   - テーブルベースの方が正確性が高い

5. 天中殺計算
   - 全エンジンのロジックで同じ（どれでも可）
```

### 5.3 mobile版の改善に必要な変更点

#### 優先度1: 十大主星・十二大従星の計算変更

**現状**:
- 通変星ロジックから十大主星を計算
- 十二運フェーズから十二大従星を計算

**推奨**:
- accurate-logicの正解データテーブルを採用
- `/mobile/lib/logic/yangsen.ts` の以下の関数を修正:
  - `getTenGreatStar()` → accurate-logicのテーブルベース版に置換
  - `getTwelveGreatStar()` → accurate-logicのテーブルベース版に置換

#### 優先度2: 蔵干計算の統一

**現状**:
- 陽占: 二十八元システム（TWENTY_EIGHT_ELEMENTS）
- 陰占: 固定蔵干（YINSEN_HIDDEN_STEMS）

**推奨**:
- 陽占・陰占ともに二十八元システムを使用
- accurate-logicの `TWENTY_EIGHT_ELEMENTS_MONTH` を採用
- `/mobile/lib/logic/constants.ts` の `YINSEN_HIDDEN_STEMS` を廃止

#### 優先度3: 胸の十大主星計算の修正

**問題**:
- 1995/9/14で正解値「調舒星」と一致しない
- mobile版は月支の蔵干を使用しているが、結果が「鳳閣星」

**推奨**:
- 月支の蔵干が正しく計算されているか検証
- 1995/9/14の月支「酉」の蔵干が「辛」ではなく「丁」になる必要がある
- 二十八元データの見直し

#### 具体的なコード変更案

**変更1: `/mobile/lib/logic/yangsen.ts`**

```typescript
// accurate-logicから十大主星テーブルをインポート
import { TEN_STARS_TABLE } from '@/lib/logic/accurate-logic-constants';

// 現在の実装（通変星ロジック）
function getTenGreatStarRaw(dayStemIdx: number, targetStemIdx: number): string {
  const dElem = getElement(dayStemIdx);
  const tElem = getElement(targetStemIdx);
  const dPol = getPolarity(dayStemIdx);
  const tPol = getPolarity(targetStemIdx);

  const rel = (tElem - dElem + 5) % 5;
  const polMatch = dPol === tPol ? 0 : 1;
  const index = rel * 2 + polMatch;

  return TEN_STARS[index];
}

// 推奨実装（正解データテーブル）
function getTenGreatStar(dayStemIdx: number, targetStemIdx: number): string {
  return TEN_STARS_TABLE[dayStemIdx][targetStemIdx];
}
```

**変更2: `/mobile/lib/logic/constants.ts`**

```typescript
// accurate-logicの正解データテーブルを追加
export const TEN_STARS_TABLE = [
  // accurate-logic/yangsen.ts のテーブルをコピー
  ['調舒星','鳳閣星','鳳閣星','調舒星','禄存星','司禄星','禄存星','車騎星','龍高星','牽牛星'], // 甲
  ['石門星','貫索星','調舒星','鳳閣星','司禄星','禄存星','牽牛星','車騎星','玉堂星','龍高星'], // 乙
  // ... 他の行も同様
];
```

**変更3: 蔵干計算の統一**

```typescript
// 陰占でも二十八元を使用するように変更
function calculateHiddenStems(bazi: FourPillars): InsenHiddenStem[] {
  // 現在: YINSEN_HIDDEN_STEMS（固定値）
  // 推奨: getYangSenHiddenStem()（二十八元）を使用
  const yearHidden = getYangSenHiddenStem(bazi.year.branchStr, 'year', date);
  const monthHidden = getYangSenMonthHiddenStem(bazi.month.branchStr, date);
  const dayHidden = getYangSenHiddenStem(bazi.day.branchStr, 'day', date);
  // ...
}
```

### 5.4 検証が必要な項目

1. **1995/9/14の正解値「調舒星」の検証**
   - どのような計算で「調舒星」になるのか
   - 使用された蔵干の値

2. **1992/3/28の天中殺「辰巳天中殺」の検証**
   - 日柱「甲子」から「辰巳天中殺」になる計算式
   - 現在の計算式では「戌亥天中殺」になる

3. **二十八元データの正確性検証**
   - accurate-logicの TWENTY_EIGHT_ELEMENTS_MONTH
   - 特に「酉」月の蔵干が「丁」になるか確認

4. **朱学院の正解データとの完全照合**
   - 全てのテストケースでaccurate-logicの結果が正解値と一致するか
   - 不一致がある場合、その原因の究明

---

## 6. まとめ

### 6.1 主要な発見

1. **四柱推命**: 全エンジンで正確に計算されている
2. **天中殺**: 全エンジンで正確に計算されている
3. **十大主星**: accurate-logicのテーブルベースが最も正確だが、正解値との不一致あり
4. **蔵干**: 二十八元システム（accurate-logic, mobile陽占）が正確

### 6.2 推奨アクション

1. mobile版をaccurate-logicの正解データテーブルベースに移行
2. 陰占でも二十八元システムを使用するように統一
3. 正解値との不一致原因を究明し、修正

### 6.3 優先順位

1. **高**: 十大主星・十二大従星のテーブル採用
2. **中**: 蔵干計算の二十八元統一
3. **低**: 不一致原因の究明（オプション）

---

## 付録: 用語集

- **四柱推命**: 年柱・月柱・日柱・時柱の4つの干支で運命を占う中国占星術
- **蔵干**: 地支に隠れている天干
- **二十八元**: 各地支の蔵干が月内の日数によって変化するシステム
- **通変星**: 日干と対象天干の関係を示す10種類の星
- **十大主星**: 算命学で使用される10種類の主星
- **十二大従星**: 算命学で使用される12種類の従星
- **天中殺**: 60干支周期で欠ける2つの支
- **節入り**: 旧暦の月が変わる日（立春、啓蟄など）
- **五虎遁**: 年干から月干を求める計算方法
- **五鼠遁**: 日干から時干を求める計算方法
