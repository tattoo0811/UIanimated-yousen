# 部分最適化問題の発見

## 問題概要

ランダムな10個の日付で検証した結果、**部分最適化（特定の日干「己」だけに対応した実装）**が発見されました。

## 検証結果

### 涼子（1977-08-20、日干「己」）
| 部位 | 私たちの計算 | 朱学院 | 一致 |
|------|-------------|--------|------|
| 右手 | 鳳閣星 | 鳳閣星 | ✓ |
| 左手 | 調舒星 | 調舒星 | ✓ |

### 1983-08-11（日干「辛」）
| 部位 | 私たちの計算 | 朱学院 | 一致 |
|------|-------------|--------|------|
| 頭 | 鳳閣星 | 鳳閣星 | ✓ |
| 胸 | 石門星 | 玉堂星 | ✗ |
| 右手 | 龍高星 | 車輢星 | ✗ |
| 左手 | 玉堂星 | 石門星 | ✗ |

### 1990-03-15（日干「己」）
| 部位 | 私たちの計算 | 朱学院 | 一致 |
|------|-------------|--------|------|
| 頭 | 禄存星 | 調舒星 | ✗ |
| 右手 | 牽牛星 | 車輢星 | ✗ |
| 左手 | 鳳閣星 | 貫索星 | ✗ |

## 根本原因

**yangsen.tsの実装が日干「乙」にハードコードされている**：

```typescript
// 右手: 日干「乙」×年干
const rightHandDayStemIdx = 1; // 「乙」のインデックス（固定値！）
const rightHand = getTenGreatStar(rightHandDayStemIdx, bazi.year.stem - 1);

// 左手: 日干「乙」×年支の本気
const leftHandDayStemIdx = 1; // 「乙」のインデックス（固定値！）
const leftHand = getTenGreatStar(leftHandDayStemIdx, yearBranchMainStemIdx);
```

この実装は、**日干「己」の場合には正しい**が、他の日干の場合には間違った結果になります。

## 正しい実装

右手・左手の計算は、**日干ごとに異なるルール**がある可能性があります：

1. **陽干（甲・丙・戊・庚・壬）**: 日干「甲」を使用
2. **陰干（乙・丁・己・辛・癸）**: 日干「乙」を使用
3. **または**: 日干そのものを使用

## 次のステップ

1. **複数の日干で検証データを収集**: 各日干（甲乙丙丁戊己庚辛壬癸）で朱学院のデータを取得
2. **パターンを特定**: どの日干でどのルールを使用するかを特定
3. **正しいロジックを実装**: 全ての日干に対応した汎用的な実装

## 修正が必要なコード

```typescript
// 現在の実装（間違い）
const rightHandDayStemIdx = 1; // 「乙」で固定
const rightHand = getTenGreatStar(rightHandDayStemIdx, bazi.year.stem - 1);

// 正しい実装（例）
// 日干に基づいて適切な日干を選択
const rightHandDayStemIdx = getRightHandDayStemIndex(dayStemIdx);
const rightHand = getTenGreatStar(rightHandDayStemIdx, bazi.year.stem - 1);
```

## まとめ

右手・左手の計算ロジックが**日干「乙」にハードコードされている**部分最適化問題を発見しました。

これは、涼子（日干「己」）だけを検証した結果、正しい実装だと誤判断してしまったことによる典型的な**過剰適合**の問題です。

次に、全ての日干で汎用的に動作する正しいロジックを特定する必要があります。
