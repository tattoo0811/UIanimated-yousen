# 算命学ロジック検証レポート（更新）

## 実行日
2026-02-10

## 進捗状況

### ✅ 修正済み

1. **年柱と日柱の入れ替えバグ**
   - lunar-javascriptライブラリが年柱と日柱を逆に返すバグを修正
   - `bazi.ts`で年柱と日柱を入れ替えて使用するように変更

2. **五行関係の計算式**
   - `(tElem - dElem + 5) % 5` から `(dElem - tElem + 5) % 5` に修正
   - 「対象が日干に何をするか」で判断するように変更

### ⏳ 修正中

1. **十大主星の計算**
   - 頭（年干）: ✅ 正常に動作
   - 胸（月支の蔵干）: ❌ 二十八元のデータか計算ロジックに問題
   - 腹（月干）: ❌ 計算ロジックに問題
   - 右手（日支の蔵干）: ❌ 二十八元のデータか計算ロジックに問題
   - 左手（年支の蔵干）: ❌ 二十八元のデータか計算ロジックに問題

2. **十二大従星の計算**
   - 左肩（年支）: ❌
   - 左足（月支）: ❌
   - 右足（日支）: ❌

## 詳細な分析

### 1983年8月11日（男性）

#### 四柱推命
| 項目 | 正解値 | 現在のロジック | 結果 |
|------|--------|----------------|------|
| 年柱 | 辛未 | 辛未 | ✅ 一致 |
| 月柱 | 庚申 | 庚申 | ✅ 一致 |
| 日柱 | 癸亥 | 癸亥 | ✅ 一致 |

#### 十大主星
| 部位 | 正解値 | 現在のロジック | 計算式 | 結果 |
|------|--------|----------------|--------|------|
| 頭 | 鳳閣星 | 鳳閣星 | 癸×辛 = 洩気・陽 | ✅ 一致 |
| 胸 | 玉堂星 | 司禄星 | 癸×戊 = 財・陰 | ❌ 不一致 |
| 腹 | 司禄星 | 調舒星 | 癸×庚 = 洩気・陰 | ❌ 不一致 |
| 右手 | 車輪星 | 玉堂星 | 癸×壬 = 印・陰 | ❌ 不一致 |
| 左手 | 石門星 | 龍高星 | 癸×丁 = 印・陽 | ❌ 不一致 |

**胸の問題:**
- 正解: 癸×? = 玉堂星（印・陰）
- 現在: 癸×戊 = 司禄星（財・陰）
- 必要な蔵干: 癸×? = 玉堂星 になる天干
  - 玉堂星はインデックス9（印・陰）
  - rel = 4（印）、polMatch = 1（陰）
  - (4 - tElem + 5) % 5 = 4 → tElem = 5（土）
  - 土・陰 → 己

**必要な修正:**
- 申の蔵干が「己（土・陰）」になる必要がある
- または、八大主星の配列が異なる可能性

### 1984年12月2日（男性）

#### 四柱推命
| 項目 | 正解値 | 現在のロジック | 結果 |
|------|--------|----------------|------|
| 年柱 | 庚午 | 庚午 | ✅ 一致 |
| 月柱 | 乙亥 | 乙亥 | ✅ 一致 |
| 日柱 | 甲子 | 甲子 | ✅ 一致 |

#### 十大主星
| 部位 | 正解値 | 現在のロジック | 計算式 | 結果 |
|------|--------|----------------|--------|------|
| 頭 | 禄存星 | 禄存星 | 甲×庚 = 財・陽 | ✅ 一致 |
| 胸 | 鳳閣星 | 鳳閣星 | 甲×丙 = 洩気・陽 | ✅ 一致 |
| 腹 | 司禄星 | 石門星 | 甲×乙 = 比和・陰 | ❌ 不一致 |
| 右手 | 牽牛星 | 調舒星 | 甲×癸 = 洩気・陰 | ❌ 不一致 |
| 左手 | 調舒星 | 玉堂星 | 甲×丙 = 印・陰 | ❌ 不一致 |

**腹の問題:**
- 正解: 甲×乙 = 司禄星（財・陰）
- 現在: 甲×乙 = 石門星（比和・陰）
- 甲（木・陽）× 乙（木・陰）
  - 木（0）- 木（0）+ 5 = 5 % 5 = 0（比和）
  - 陽 ≠ 陰 → 1
  - インデックス: 0 * 2 + 1 = 1 → 石門星

**問題:**
- 甲×乙 は「比和」ではなく「財」になるべき
- これは五行関係の定義が異なる可能性を示している

## 次のステップ

### 優先度1: 十大主星の配列と五行関係の確認

**問題点:**
1. 甲（木・陽）× 乙（木・陰）が「比和」ではなく「財」になる
2. 朱学院の十大主星の定義が異なる可能性

**解決策:**
1. 朱学院の十大主星の定義を確認
2. 五行関係のマッピング表を再確認
3. すべての組み合わせ（10×10=100通り）のテストケースを作成

### 優先度2: 二十八元（蔵干）データの確認

**問題点:**
1. 申の蔵干が「己（土・陰）」になる必要がある
2. 現在のデータでは「戊（土・陽）」
3. 節入りからの日数計算が正しいか確認

**解決策:**
1. 朱学院の二十八元データを確認
2. 節入りからの日数計算を検証
3. 必要に応じてデータを修正

### 優先度3: 十二大従星の計算ロジック

**問題点:**
1. 位相の計算式が正しいか確認
2. 星の配列が正しいか確認

**解決策:**
1. 建禄支の計算を確認
2. 位相の計算式を確認
3. 星の配列を確認

## 参考資料

- 正解値JSON: `claudedocs/expected_values_from_shugakuin.json`
- 現在のロジック: `src/bazi.ts`, `src/yangsen.ts`, `src/constants.ts`
- テストファイル: `tests/verification.test.ts`
- 検証レポート: `claudedocs/verification_report.md`
