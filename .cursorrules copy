# Cursor Rules for Multi-Agent Development

このプロジェクトは複数のAIエージェント（Cursor、Gemini/Antigravity、Claude Code、Ralph）が並列で作業するための設定です。

## Cursorの役割

**Cursorは高速実装のメインエージェントです。**

- **高速な実装**: シンプルで明確なタスクを迅速に実装
- **Claude Skills活用**: APIの代わりにClaudeのskillsを使用可能
- **インタラクティブ開発**: ユーザーとの対話的な開発

## プロジェクト概要

- **Issue Tracking**: Beads (bd) を使用
- **自動化**: Ralph による高速ループ開発
- **並列作業**: 複数エージェントが競合せずに作業
- **役割分担**: 各エージェントが最適なタスクを自動選択

## Beads統合

### 必須ワークフロー

**重要**: Beadsに登録されていないタスクは実行禁止。必要なら先にタスクを作成してから実行。

1. **作業開始前**
   ```bash
   bd ready                    # 利用可能なタスクを確認
   bd show <id>                # タスク詳細を確認
   bd update <id> --status in_progress  # タスクを開始
   ```

2. **タスクが存在しない場合**
   - 自発的にタスクを追加してもよい
   - ただし、必ず `bd create` でタスクを作成してから作業開始
   - タスク作成なしでの作業は禁止
   - **重要**: 一連の作業の最後のタスクには `[FINISH]` タグを付けること

3. **作業中**
   - タスクIDをコミットメッセージに含める: `feat: [toukei-xxxx] - [説明]` (注: 旧 sonpoGPT は toukei に読み替え)
   - 関連するタスクは `bd dep add <child> <parent>` でリンク
   - 依存関係がある場合はタイトルに `[after:toukei-xxx]` を含めて視覚的に明示した上でリンク
   - 作業グループの最終タスクには `[FINISH]` をタイトルに付与
   - **重要**: 1タスク1コミットを徹底（複数タスクを1つのコミットにまとめない）

4. **作業完了時**
   ```bash
   bd close <id>               # タスクを完了
   git add <変更ファイル>        # 該当タスクのファイルのみ
   git commit -m "feat: [toukei-xxxx] - [説明]"
   bd sync                     # Gitと同期
   git push                    # 必須: リモートにプッシュ
   ```
   - **[FINISH] タスクの場合**: `bd close` の前に必ず `ccm` コマンドを使用してコンフリクトチェックとマージ、プッシュを実行すること（詳細は `docs/ccm-command.md` 参照）

   **重要**: `bd sync` が失敗する場合、`sync.branch` が設定されていない可能性があります。
   初回セットアップ時は以下を実行:
   ```bash
   bd config set sync.branch beads-sync  # または main ブランチを使用する場合
   ```

4. **レビュー依頼（推奨）**
   複数タスク完了時や重要な実装後は、Gemini/Antigravityに確認を依頼：
   ```bash
   bd create "[OPUS] タスク名のレビュー依頼" -p 0 --description="完了内容と確認事項を記述"
   ```
   - `[OPUS]` タグでGemini/Antigravityが拾う
   - 確認事項（型定義の妥当性、設計との整合性等）を記述

## Git運用ルール (CRITICAL)

**並行作業時のコンフリクトを防ぐため、Feature Branch Workflowを徹底してください。**

1. **タスク開始時**: 専用ブランチを作成
   ```bash
   # ブランチ名は task/<taskId> 形式
   git checkout -b task/sonpoGPT-xxxx
   ```

2. **作業中**: こまめにコミット
   ```bash
   git add .
   git commit -m "feat(scope): 変更内容の詳細 #taskId"
   ```

3. **タスク完了時**: リモートへプッシュ
   ```bash
   git push origin task/sonpoGPT-xxxx
   # その後、Pull Requestを作成するか、メインブランチへマージ（運用による）
   ```

4. **ルール**:
   - **`main` ブランチへの直接プッシュは原則禁止**（特に並行作業時）
   - タスクが完了したら、必ずリモートにプッシュして他のエージェントと同期可能な状態にする
   - `bd close` する前にプッシュを完了させる

5. **禁止事項**:
   - 巨大な変更を一度にまとめてコミットしないこと
   - ビルドが通らない状態でのプッシュ（WIPコミットはローカルに留める）

### タスク命名規則

- タスクIDは `sonpoGPT-<hash>` 形式（例: `sonpoGPT-a3f2dd`）
- コミットメッセージにタスクIDを含める
- 関連タスクは階層構造を使用可能: `sonpoGPT-a3f8.1.1`

## 並列作業のためのルール

### 1. ファイルロック戦略

- **作業開始前に確認**: `git status` で未コミットの変更を確認
- **ブランチ分離**: 各エージェントは独立したブランチで作業
- **小さなコミット**: 頻繁にコミットして競合を最小化

### 2. コンフリクト回避

- **ファイル単位の作業**: 可能な限り異なるファイルを編集
- **Beadsでタスクを予約**: `bd update <id> --status in_progress` でタスクを予約
- **作業前に同期**: `git pull --rebase` を実行

### 3. メモリ共有

- **AGENTS.md**: プロジェクト全体のパターンと学習
- **progress.txt**: Ralphセッションの進捗（`scripts/ralph/progress.txt`）
- **Beads Issues**: 構造化されたタスク管理

## コード品質

### TypeScript/Next.js

- **型チェック**: `npm run build` で型エラーを確認
- **Lint**: `npm run lint` を実行
- **テスト**: 可能な限りテストを追加

### コミット規約

```
feat: [sonpoGPT-xxxx] - 機能追加
fix: [sonpoGPT-xxxx] - バグ修正
refactor: [sonpoGPT-xxxx] - リファクタリング
docs: [sonpoGPT-xxxx] - ドキュメント更新
```

## ビルド検証と自己修正パターン (CRITICAL)

### タスク完了前の必須チェック

**すべてのタスクは、closeする前にビルド検証を実行すること。**

```bash
# 必須: ビルドテスト
npm run build

# エラーがあれば自己修正
# 1. エラーメッセージを確認
# 2. 該当ファイルを修正
# 3. 再度ビルドテスト
# 4. 成功するまで繰り返し
```

### 自動検証タスクの作成パターン

複数のタスクを作成する際は、最後に検証タスクを含めること：

```bash
# 実装タスク群
bd create "[CURSOR] 機能Aの実装" -p 1
bd create "[CURSOR] 機能Bの実装" -p 1

# 検証タスク（依存関係を設定）
bd create "[VERIFY] 機能A,Bのビルド検証と統合テスト" -p 1
bd dep add <verify-task-id> <task-a-id>
bd dep add <verify-task-id> <task-b-id>
```

### タグの使い分け

| タグ | 用途 | 担当 |
|------|------|------|
| `[VERIFY]` | ビルド検証・自己修正 | Cursor |
| `[AUDIT]` | 最終監査・レビュー | Gemini/Antigravity |
| `[QA]` | 品質保証テスト | 任意 |

### 検証タスクの内容

`[VERIFY]` タスクは以下を含む：

1. `npm run build` でビルド成功を確認
2. 型エラーがあれば修正
3. `npm run lint` でLintエラー確認・修正
4. 関連するStorybookストーリーの動作確認（該当する場合）
5. 修正内容をコメントに記録

### 最終監査タスクの作成（推奨）

大きな機能や複数タスクの完了時は、監査タスクを作成：

```bash
bd create "[AUDIT] 機能名の最終監査" -p 0 --description="
## 確認項目
- [ ] ビルド成功
- [ ] 型エラーなし
- [ ] 設計との整合性
- [ ] エッジケースの考慮
- [ ] ドキュメント更新"
```

## Ralph統合

Ralphが動作中の場合:

1. **Ralphのタスクを尊重**: `scripts/ralph/prd.json` を確認
2. **進捗を確認**: `scripts/ralph/progress.txt` を読む
3. **パターンを共有**: 発見したパターンは `progress.txt` の「Codebase Patterns」セクションに追加

## セッション終了時の必須ステップ

**Landing the Plane** - セッション終了時は以下を必ず実行:

1. **残りの作業をIssue化**: `bd create "タイトル" -p 0`
2. **品質ゲート**: `npm run build && npm run lint`
3. **Issue状態更新**: 完了したタスクを `bd close`
4. **同期とプッシュ**:
   ```bash
   git pull --rebase
   bd sync  # 失敗する場合は sync.branch の設定を確認
   git push
   git status  # "up to date with origin" を確認
   ```
5. **クリーンアップ**: スタッシュのクリア、リモートブランチの整理
6. **検証**: すべての変更がコミット・プッシュ済みであることを確認

**重要**: 作業は `git push` が成功するまで完了とみなさない

## Beadsトラブルシューティング

### `bd sync` が失敗する場合

`bd sync` が失敗する主な原因と対処法:

1. **`sync.branch` が設定されていない**（最も一般的）
   ```bash
   # 設定を確認
   bd config get sync.branch
   
   # 設定されていない場合、設定する
   bd config set sync.branch beads-sync  # または main
   ```

2. **Gitのコンフリクト**
   - リモートとローカルでコンフリクトが発生した場合
   - 解決: コンフリクトを解決してから再実行

3. **リモートへのアクセス権限**
   - リモートリポジトリへのアクセス権限がない場合
   - 解決: 認証情報を確認

4. **未コミットの変更**
   - `.beads/issues.jsonl` に未コミットの変更がある場合
   - 解決: 変更をコミットまたはスタッシュ

## ファイル構造

```
sonpoGPT/
├── .beads/              # Beadsデータベース
├── scripts/
│   └── ralph/          # Ralph自動化スクリプト
│       ├── ralph.sh
│       ├── prompt.md
│       ├── prd.json
│       └── progress.txt
├── AGENTS.md           # プロジェクト全体の学習
└── .cursorrules        # このファイル
```

## タスク選択の自動化

### Cursorが優先的に担当するタスク

Cursorは以下のタスクを優先的に担当します：

- **高速実装が必要なタスク**: `[CURSOR]` タグまたは `[FAST]` タグ
- **シンプルな実装**: 明確な要件で迅速に実装できるタスク
- **UIコンポーネント**: フロントエンドの実装
- **API統合**: 外部APIとの連携（Claude Skills使用可能）

### タスクの自動分離

Beadsのタスクにタグを使用して自動分離：

```bash
# Cursor向けタスクの作成例
bd create "[CURSOR] UIコンポーネントの実装" -p 1
bd create "[FAST] APIエンドポイントの追加" -p 1
```

タスクの説明に以下のタグがある場合、Cursorが優先的に担当：
- `[CURSOR]` - Cursor専用
- `[FAST]` - 高速実装が必要
- `[UI]` - UIコンポーネント
- `[API]` - API実装（Claude Skills使用可能）

## Claude Skillsの使用

APIの代わりにClaude Skillsを使用する場合：

1. **Skillsの確認**: 利用可能なskillsを確認
2. **適切なskillを選択**: タスクに最適なskillを使用
3. **統合**: skillの結果をコードに統合

例：
- ブラウザ操作が必要な場合: dev-browser skill
- ファイル操作が必要な場合: 適切なfile skill
- 複雑な処理が必要な場合: 専用skill

## エージェント間の協調

### 役割分担

- **Cursor**: 高速実装のメイン（このエージェント）
  - シンプルで明確なタスクを迅速に実装
  - Claude Skillsを活用した開発
- **Gemini/Antigravity**: 作業計画の中心（`gemini.md` を参照）
  - Opus 4.5での作業計画
  - 複雑な設計とアーキテクチャ
  - GeminiまたはClaudeを使用可能
- **Claude Code**: 汎用的な開発タスク（`claude.md` を参照）
  - 複雑なロジックの実装
  - バグ修正とリファクタリング
- **Ralph**: 自動化された反復開発ループ
  - 小さなストーリーの自動実装

### 協調のルール

1. **計画の尊重**: Gemini/Antigravityが計画を立てた場合、その計画に従う
2. **タスクの予約**: Beadsでタスクを予約してから作業開始
3. **メモリ共有**: 発見したパターンは `AGENTS.md` に追加
4. **競合回避**: 他のエージェントが作業中のファイルは避ける

各エージェントは独立して動作できますが、Beadsを通じてタスクを共有し、役割に応じて自動的にタスクを選択します。

## ファイル削除のルール

**重要**: 以下のファイル・ディレクトリは絶対に削除してはいけません。

### 保護対象（削除禁止）

1. **Git関連**
   - `.git/` - Gitリポジトリ全体
   - `.gitignore` - Git除外設定

2. **Beads関連**
   - `.beads/` - Beadsデータベース全体
   - `.beads/issues.jsonl` - タスクデータ
   - `.beads/metadata.json` - メタデータ

3. **プロジェクト設定**
   - `.cursorrules` - このファイル（エージェント設定）
   - `AGENTS.md` - エージェント間の共有メモリ
   - `package.json` - プロジェクト依存関係
   - `tsconfig.json` - TypeScript設定

4. **重要なディレクトリ**
   - `node_modules/` - 依存関係（再インストール可能だが時間がかかる）
   - `.cursor/` - Cursor設定

### 削除時のルール

- **`rm`コマンドは使用禁止**: Cursorのallowlistから除外済み
- **ファイル削除が必要な場合**: 
  - 必ずユーザーに確認を取る
  - 削除前にGitで状態を確認（`git status`）
  - 重要なファイルは削除前にバックアップを検討
- **一時ファイルの削除**: `dist/`, `.next/`, `build/` などのビルド成果物は削除可能
- **削除ツール**: 必要に応じて `delete_file` ツールを使用（より安全）

