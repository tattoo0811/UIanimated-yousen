# Plan 09-01: Image Generation Prompt System

**Phase:** 09 - Image Generation Prompts
**Created:** 2026-01-24
**Estimated Time:** 60 minutes
**Dependencies:** Phase 08 (Content Translation)
**Scope:** Backend + Mobile

## Objective

Create a system that generates AI image prompts based on user's fortune results, enabling users to create custom images using DALL-E, Midjourney, or other image generation tools.

**Why:** Users want visual representations of their fortune that they can share on social media. Providing AI-ready prompts extends the app's value beyond video content.

**Success Criteria:**
1. Backend generates image prompts based on day stem, theme, and selected tone
2. Mobile app displays generated prompts with copy-to-clipboard functionality
3. Prompts are optimized for DALL-E/Midjourney (clear, descriptive, style-specific)
4. User can generate prompts for each section (essence, family, work, love)

## Context

### Existing Systems

**Content Generation** (@backend/src/lib/contentGenerator.ts)
- Day stem-based content patterns (10 variations)
- 5 sections: essence, family, work, love, ochi
- Tone system: TikTok, YouTube, Instagram

**Translation System** (@backend/src/lib/contentTranslator.ts)
- Rule-based tone transformation
- Keyword extraction for personality types
- Platform-specific templates

**Mobile Result Screen** (@mobile/app/result.tsx)
- Displays PopResultCard with fortune results
- Navigation structure: header, result card, bottom button
- Uses kanshi (day stem + branch) for fortune lookup

### Data Structures

**SanmeigakuInsenChart** (@mobile/src/types/index.ts)
```typescript
{
  pillars: { year, month, day: { stem, branch } },
  fiveElements: { distribution, dayStemStrength },
  tsuhensei: [{ pillar, stem, name }], // é€šå¤‰æ˜Ÿ
  junishiUn: [{ pillar, branch, state }], // åäºŒé‹
}
```

## Tasks

### Task 1: Backend Image Prompt Generator (30 min)

**File:** `backend/src/lib/imagePromptGenerator.ts` (create new)

**Requirements:**
1. Create `generateImagePrompt()` function that takes:
   - `insen: SanmeigakuInsenChart`
   - `section: 'essence' | 'family' | 'work' | 'love'`
   - `tone: 'TikTok' | 'YouTube' | 'Instagram'`
   - `theme: 'KiraPop' | 'MonoEdge' | 'ZenWa'`

2. Generate prompts with structure:
   - **Subject**: Based on day stem characteristics
   - **Style**: Theme-specific visual style
   - **Mood**: Tone-specific emotional tone
   - **Composition**: Platform-optimized composition

3. Day stem visual patterns (10 variations):
   - ç”² (Ki): Strong tree, leadership, upright posture, green/brown
   - ä¹™ (Otsu): Flexible grass, graceful movement, nature, soft curves
   - ä¸™ (Hei): Sun, bright light, warmth, orange/gold, radiating energy
   - ä¸ (Tei): Candle flame, gentle glow, warmth, intimate lighting
   - æˆŠ (Bo): Mountain, stability, solid form, earth tones, grounded
   - å·± (Ki): Fertile field, nurturing, growth, agriculture, abundance
   - åºš (Kou): Sword/metal, sharp lines, precision, metallic shine
   - è¾› (Shin): Gemstone/jewelry, refined beauty, sparkle, elegance
   - å£¬ (Jin): Ocean/waves, vastness, flow, blue gradients, freedom
   - ç™¸ (Ki): Rain/dew, subtle beauty, mist, soft lighting, tranquility

4. Theme visual styles:
   - **KiraPop**: Vibrant colors, pop art, energetic, high contrast
   - **MonoEdge**: Monochrome with indigo accents, minimalist, modern
   - **ZenWa**: Earth tones, Japanese aesthetics, natural, serene

5. Tone moods:
   - **TikTok**: Emotional, dramatic, high energy, bold
   - **YouTube**: Storytelling, warm, relatable, authentic
   - **Instagram**: Aesthetic, curated, visual, hashtag-friendly

6. Return structured prompt:
```typescript
{
  prompt: string;        // Full prompt for AI
  style: string;         // Style description
  negativePrompt: string; // What to avoid
  suggestedFormat: string; // Aspect ratio recommendation
}
```

**Verification:**
- Function exists at `backend/src/lib/imagePromptGenerator.ts`
- Exports `generateImagePrompt()` with correct signature
- Has 10 day stem patterns with visual descriptions
- Has 3 theme style patterns
- Has 3 tone mood patterns
- Returns structured object with prompt, style, negativePrompt, suggestedFormat

### Task 2: Backend API Endpoint (15 min)

**File:** `backend/src/api/routes/contentRoutes.ts` (create new)

**Requirements:**
1. Add GET endpoint `/api/image-prompt`
2. Query params: `kanshi`, `section`, `tone`, `theme`
3. Call `generateImagePrompt()` with parsed params
4. Return JSON response with prompt data
5. Add error handling for invalid params

**Example Request:**
```
GET /api/image-prompt?kanshi=ä¸™åˆ&section=essence&tone=TikTok&theme=KiraPop
```

**Example Response:**
```json
{
  "prompt": "A charismatic person with sun-like radiance, standing confidently with arms spread open, warm golden light emanating from their body, vibrant orange and yellow color palette, pop art style with bold outlines, high contrast, energetic atmosphere, cinematic lighting, 4k quality",
  "style": "Vibrant pop art with bold colors and high energy",
  "negativePrompt": "dark, gloomy, low contrast, muted colors, sad expression",
  "suggestedFormat": "9:16 (vertical for TikTok)"
}
```

**Verification:**
- Endpoint exists at `/api/image-prompt`
- Accepts kanshi, section, tone, theme params
- Returns structured prompt data
- Has error handling for invalid params
- Validated with curl or Postman

### Task 3: Mobile Image Prompt Screen (30 min)

**File:** `mobile/app/image-prompts.tsx` (create new)

**Requirements:**
1. Create new screen accessible from result.tsx
2. Fetch image prompts from backend API
3. Display 4 prompts (essence, family, work, love) in card layout
4. Each prompt card shows:
   - Section title with emoji icon
   - Full prompt text (scrollable if long)
   - Copy button with haptic feedback
   - Style badge (KiraPop/MonoEdge/ZenWa)
   - Format suggestion (9:16, 1:1, etc.)

5. Copy functionality:
   - Use `Clipboard.setStringAsync()` from expo-clipboard
   - Show toast notification on successful copy
   - Haptic feedback on button press
   - Copy full prompt to clipboard

6. Styling:
   - Match current app theme (#FFF9E6 background)
   - Use PopResultCard visual style (border, shadow, rounded corners)
   - Section icons: ğŸŒŸ (essence), ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ (family), ğŸ’¼ (work), ğŸ’• (love)
   - Scrollable container for multiple cards

7. Navigation:
   - Add "AIç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" button to result.tsx bottom section
   - Use `router.push('/image-prompts')` for navigation
   - Back button to return to result screen

**Screen Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æˆ»ã‚‹    AIç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚ ğŸŒŸ æœ¬è³ªã®ã‚¤ãƒ¡ãƒ¼ã‚¸            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ A charismatic person... â”‚ â”‚
â”‚ â”‚ (scrollable text)       â”‚ â”‚
â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚ Style: KiraPop          â”‚ â”‚
â”‚ â”‚ Format: 9:16            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        [ğŸ“‹ Copy]           â”‚
â”‚                             â”‚
â”‚ ğŸ’• æ‹æ„›ã®ã‚¤ãƒ¡ãƒ¼ã‚¸            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Romantic scene with...  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        [ğŸ“‹ Copy]           â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Verification:**
- Screen exists at `mobile/app/image-prompts.tsx`
- Fetches prompts from backend API
- Displays 4 section prompts in card layout
- Copy button copies prompt to clipboard
- Shows toast notification on copy
- Has haptic feedback on button press
- Navigation button added to result.tsx
- Screen matches app visual style

### Task 4: AsyncStorage Caching (15 min)

**File:** `mobile/src/lib/cache.ts` (extend existing)

**Requirements:**
1. Add `saveImagePrompt()` and `loadImagePrompt()` functions
2. Cache prompts by kanshi + tone + theme key
3. Load from cache before API call
4. Use 24-hour cache expiration

**Verification:**
- Functions added to cache.ts
- Prompts cached with correct key format
- Cache checked before API call
- Cache expires after 24 hours

## Execution Wave

**Wave 1** (Task 1):
- Backend image prompt generator

**Wave 2** (Task 2):
- Backend API endpoint

**Wave 3** (Tasks 3-4, parallel):
- Mobile image prompt screen
- AsyncStorage caching

## Success Metrics

1. Backend generates 40 unique prompts (10 stems Ã— 4 sections)
2. Each prompt is 50-200 characters, AI-ready
3. Mobile app displays prompts without errors
4. Copy functionality works on iOS and Android
5. Cached prompts load offline within 24 hours

## Risk Mitigation

**Risk:** API prompts may be too generic
**Mitigation:** Test with DALL-E/Midjourney during development, refine prompt templates

**Risk:** Clipboard API permissions on iOS
**Mitigation:** Add error handling with user-friendly message if clipboard fails

**Risk:** Too much visual content on mobile screen
**Mitigation:** Use scrollable cards, show one section at a time with tabs if needed

## Notes

- Prompts should be in English for better AI image generation
- Include negative prompts to improve quality
- Suggest aspect ratios based on platform (9:16 for TikTok, 1:1 for Instagram)
- Consider adding prompt regeneration button in future iterations
- Could add preset image gallery in future phases
