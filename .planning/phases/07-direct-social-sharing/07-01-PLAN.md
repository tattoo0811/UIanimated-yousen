# Plan 07-01: URLスキームによるTikTok/Instagram連携の実装

**Phase:** 07 - Direct Social Sharing
**Wave:** 1 of 2
**Estimated:** 30-40 minutes
**Context:** ~50% (mobile app, extends videoShare.ts from 06-02)

## Goal

TikTokおよびInstagramアプリに動画を直接渡すためのURLスキーム連携を実装する

## Success Criteria

1. TikTokアプリがインストールされている場合、直接投稿画面を開ける
2. Instagramアプリがインストールされている場合、直接投稿画面を開ける
3. 動画ファイルが正しく各アプリに渡される
4. videoShare.tsに直接共有関数が追加されている

## Prerequisites

- Plan 06-02 complete (videoShare.ts exists with native share sheet)
- Expo SDK 54 environment
- expo-linking already installed

## Tasks

### Task 1: TikTok/Instagram URLスキーム調査と定数定義

**Files:**
- `mobile/src/lib/socialShare.ts` (new)

**Dependencies:** None
**Creates:** Social sharing constants and URL scheme definitions

**Steps:**
1. Research URL schemes:
   - TikTok: `snssdk1233://` or `tiktok://` scheme
   - Instagram: `instagram://` scheme
   - Note: Instagram Stories sharing uses `instagram-library://` scheme

2. Create `mobile/src/lib/socialShare.ts`:
   ```typescript
   // URL schemes
   export const TIKTOK_SCHEME = 'snssdk1233://';
   export const INSTAGRAM_SCHEME = 'instagram://';
   export const INSTAGRAM_STORIES_SCHEME = 'instagram-stories://';

   // App store URLs (fallback)
   export const TIKTOK_APP_STORE = 'https://apps.apple.com/app/tiktok-make-your-day/id835599320';
   export const INSTAGRAM_APP_STORE = 'https://apps.apple.com/app/instagram/id389801252';

   // Fallback web URLs
   export const TIKTOK_WEB = 'https://www.tiktok.com/';
   export const INSTAGRAM_WEB = 'https://www.instagram.com/';

   export interface SocialShareConfig {
     platform: 'tiktok' | 'instagram';
     videoPath: string;
     caption?: string;
   }
   ```

3. Document URL scheme parameters:
   - TikTok: Opens share dialog when video path is provided
   - Instagram: Requires background image/video for Stories
   - Both apps: Fall back to app store if not installed

**Acceptance:**
- [ ] Constants file created with all URL schemes
- [ ] TypeScript types defined for SocialShareConfig
- [ ] Comments document supported URL schemes and parameters
- [ ] App store and web fallback URLs defined

---

### Task 2: 直接共有関数の実装（expo-linking使用）

**Files:**
- `mobile/src/lib/socialShare.ts` (modify)
- `mobile/src/lib/videoShare.ts` (modify)

**Dependencies:** Task 1 (URL scheme constants)
**Creates:** Direct share functions for TikTok/Instagram

**Steps:**
1. Implement `shareToTikTok` function in `socialShare.ts`:
   ```typescript
   import * as Linking from 'expo-linking';
   import { Platform } from 'react-native';

   export async function shareToTikTok(
     videoPath: string,
     caption?: string
   ): Promise<{ success: boolean; error?: string }> {
     try {
       // TikTok URL scheme for sharing
       // Note: TikTok may require specific encoding
       const encodedPath = encodeURIComponent(videoPath);
       const url = `${TIKTOK_SCHEME}share?video=${encodedPath}`;

       const canOpen = await Linking.canOpenURL(url);
       if (!canOpen) {
         return {
           success: false,
           error: 'TikTok app not installed',
         };
       }

       await Linking.openURL(url);
       return { success: true };
     } catch (error) {
       return {
         success: false,
         error: `Failed to open TikTok: ${error}`,
       };
     }
   }
   ```

2. Implement `shareToInstagram` function:
   ```typescript
   export async function shareToInstagram(
     videoPath: string
   ): Promise<{ success: boolean; error?: string }> {
     try {
       // Instagram Stories background video sharing
       const encodedPath = encodeURIComponent(videoPath);
       const url = `${INSTAGRAM_STORIES_SCHEME}background_video?video_url=${encodedPath}`;

       const canOpen = await Linking.canOpenURL(url);
       if (!canOpen) {
         return {
           success: false,
           error: 'Instagram app not installed',
         };
       }

       await Linking.openURL(url);
       return { success: true };
     } catch (error) {
       return {
         success: false,
         error: `Failed to open Instagram: ${error}`,
       };
     }
   }
   ```

3. Update `mobile/src/lib/videoShare.ts`:
   - Import functions from socialShare.ts
   - Add `shareToTikTok` and `shareToInstagram` to exports
   - Update VideoShareResult type to include 'tiktok' and 'instagram' methods

4. Add iOS Info.plist queries for canOpenURL:
   ```json
   // mobile/app.json
   "ios": {
     "infoPlist": {
       "LSApplicationQueriesSchemes": ["snssdk1233", "tiktok", "instagram", "instagram-stories"]
     }
   }
   ```

**Implementation Details:**
- expo-linking is already installed (from package.json)
- Both functions check if app is installed with `canOpenURL`
- Error messages indicate when app is not installed
- Platform-specific handling if needed (iOS vs Android)

**Acceptance:**
- [ ] shareToTikTok function implemented
- [ ] shareToInstagram function implemented
- [ ] Functions exported from videoShare.ts
- [ ] iOS LSApplicationQueriesSchemes configured
- [ ] Error handling covers app not installed case
- [ ] TypeScript types are correct

---

### Task 3: UIコンポーネントへの直接共有ボタン追加

**Files:**
- `mobile/src/components/VideoControls.tsx` (modify)

**Dependencies:** Task 2 (share functions implemented)
**Creates:** Enhanced share UI with direct social sharing buttons

**Steps:**
1. Update VideoControls component:
   - Add TikTok share button (icon: Music/Video from lucide-react-native)
   - Add Instagram share button (icon: Camera/Instagram from lucide-react-native)
   - Style buttons to appear below existing Share button
   - Use TikTok brand color: #000000 (black) or #25F4EE (cyan)
   - Use Instagram brand color: #E1306C (gradient)

2. Button layout:
   ```
   [Download] [Share]
   [ TikTok ] [Instagram]
   ```

3. Implement handlers:
   ```typescript
   import { shareToTikTok, shareToInstagram } from '@/lib/videoShare';

   const handleTikTokShare = async () => {
     const result = await shareToTikTok(videoUri);
     if (!result.success) {
       Alert.alert('Error', result.error || 'Failed to open TikTok');
     }
   };

   const handleInstagramShare = async () => {
     const result = await shareToInstagram(videoUri);
     if (!result.success) {
       Alert.alert('Error', result.error || 'Failed to open Instagram');
     }
   };
   ```

4. Add haptic feedback on button press (expo-haptics)

5. Update test screen to verify new buttons:
   - `mobile/app/test-video.tsx`
   - Test TikTok button opens app
   - Test Instagram button opens app

**Implementation Details:**
```typescript
// VideoControls.tsx additions
interface VideoControlsProps {
  videoUri: string;
  showDirectShare?: boolean; // New prop to show/hide direct share buttons
  // ... existing props
}
```

**Acceptance:**
- [ ] TikTok button visible and clickable
- [ ] Instagram button visible and clickable
- [ ] Buttons use brand-appropriate colors
- [ ] Haptic feedback on button press
- [ ] Error alerts show when apps not installed
- [ ] Layout doesn't break existing share/download buttons
- [ ] Test screen verifies functionality

## Integration Notes for Next Plan

**For Plan 07-02 (App Detection & Fallback):**
- Error messages from share functions will indicate "app not installed"
- Use these messages to trigger fallback UI
- App store URLs are already defined in constants

**Known Limitations:**
- TikTok/Instagram APIs change frequently; URL schemes may break
- Direct file passing may not work on all Android versions
- iOS backgrounding restrictions may affect file passing
- Fallback to native share sheet is always available

## Testing

- **iOS:** Test with TikTok and Instagram installed
- **iOS:** Test with apps NOT installed (verify error message)
- **Android:** Test with TikTok and Instagram installed
- **Android:** Test with apps NOT installed
- **File passing:** Verify video file is accessible to target app
- **Error cases:** Invalid video path, missing file, permission denied

## Rollback Strategy

- Remove socialShare.ts if URL schemes don't work
- Revert VideoControls.tsx to previous version
- Keep native share sheet as working fallback

## Notes

- URL schemes may change without notice; monitor for breaking changes
- TikTok's official documentation is limited; community resources often more helpful
- Instagram Stories sharing requires specific background content format
- Consider using Branch or other deep linking services for more robust handling
- Test on real devices (emulators may not have social apps installed)

## References

- [TikTok Deep Links Documentation](https://ads.tiktok.com/help/article/understanding-deeplinks-and-deferred-deeplinks)
- [Instagram URL Schemes](https://dev.to/ahandsel/instagram-url-schemes-1k6n)
- [Expo Linking API](https://docs.expo.dev/versions/latest/sdk/linking/)
