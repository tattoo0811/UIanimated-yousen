# Plan 07-02: アプリインストール検出とフォールバック処理

**Phase:** 07 - Direct Social Sharing
**Wave:** 2 of 2
**Estimated:** 25-35 minutes
**Context:** ~50% (mobile app, depends on 07-01)

## Goal

TikTok/Instagramアプリが未インストールの場合の適切なフォールバック処理を実装する

## Success Criteria

1. アプリが未インストールの場合、ユーザーフレンドリーなメッセージが表示される
2. App Storeへの直接リンクが提供される
3. ネイティブシェアシートへのフォールバックが機能する
4. UI/UXがスムーズで混乱を生じない

## Prerequisites

- Plan 07-01 complete (URL schemes and share functions exist)
- Plan 06-02 complete (native share sheet works)

## Tasks

### Task 1: アプリインストール検出関数の実装

**Files:**
- `mobile/src/lib/socialShare.ts` (modify)

**Dependencies:** 07-01 (URL scheme constants)
**Creates:** App detection utilities

**Steps:**
1. Implement app detection functions:
   ```typescript
   export async function isTikTokInstalled(): Promise<boolean> {
     try {
       // Check multiple possible TikTok schemes
       const schemes = [
         `${TIKTOK_SCHEME}share`,
         `tiktok://`,
       ];

       for (const scheme of schemes) {
         const canOpen = await Linking.canOpenURL(scheme);
         if (canOpen) return true;
       }
       return false;
     } catch (error) {
       console.error('Error checking TikTok installation:', error);
       return false;
     }
   }

   export async function isInstagramInstalled(): Promise<boolean> {
     try {
       const schemes = [
         `${INSTAGRAM_STORIES_SCHEME}background_video`,
         `${INSTAGRAM_SCHEME}user`,
       ];

       for (const scheme of schemes) {
         const canOpen = await Linking.canOpenURL(scheme);
         if (canOpen) return true;
       }
       return false;
     } catch (error) {
       console.error('Error checking Instagram installation:', error);
       return false;
     }
   }
   ```

2. Add helper function to open app store:
   ```typescript
   export async function openAppStore(platform: 'tiktok' | 'instagram'): Promise<void> {
     const url = platform === 'tiktok' ? TIKTOK_APP_STORE : INSTAGRAM_APP_STORE;
     const canOpen = await Linking.canOpenURL(url);

     if (canOpen) {
       await Linking.openURL(url);
     } else {
       // Fallback to web
       const webUrl = platform === 'tiktok' ? TIKTOK_WEB : INSTAGRAM_WEB;
       await Linking.openURL(webUrl);
     }
   }
   ```

3. Export functions from videoShare.ts:
   ```typescript
   export { isTikTokInstalled, isInstagramInstalled, openAppStore } from './socialShare';
   ```

**Acceptance:**
- [ ] isTikTokInstalled function works
- [ ] isInstagramInstalled function works
- [ ] openAppStore opens correct app store
- [ ] Functions handle errors gracefully
- [ ] TypeScript types are correct

---

### Task 2: エラーハンドリングとユーザー通知の改善

**Files:**
- `mobile/src/lib/socialShare.ts` (modify)
- `mobile/src/components/VideoControls.tsx` (modify)

**Dependencies:** Task 1 (app detection functions)
**Creates:** Enhanced error handling with user-friendly messages

**Steps:**
1. Update share functions to return detailed error info:
   ```typescript
   export interface SocialShareResult {
     success: boolean;
     error?: string;
     appInstalled?: boolean;
     platform: 'tiktok' | 'instagram';
   }

   export async function shareToTikTok(
     videoPath: string,
     caption?: string
   ): Promise<SocialShareResult> {
     try {
       const isInstalled = await isTikTokInstalled();

       if (!isInstalled) {
         return {
           success: false,
           error: 'TikTok app is not installed',
           appInstalled: false,
           platform: 'tiktok',
         };
       }

       const encodedPath = encodeURIComponent(videoPath);
       const url = `${TIKTOK_SCHEME}share?video=${encodedPath}`;

       await Linking.openURL(url);
       return {
         success: true,
         platform: 'tiktok',
         appInstalled: true,
       };
     } catch (error) {
       return {
         success: false,
         error: `Failed to open TikTok: ${error}`,
         appInstalled: true,
         platform: 'tiktok',
       };
     }
   }

   // Similar for shareToInstagram
   ```

2. Create alert helper function:
   ```typescript
   export async function showAppNotInstalledAlert(
     platform: 'tiktok' | 'instagram'
   ): Promise<void> {
     const platformName = platform === 'tiktok' ? 'TikTok' : 'Instagram';

     return new Promise((resolve) => {
       Alert.alert(
         `${platformName} Not Installed`,
         `${platformName} app is required to share directly. Would you like to download it from the App Store?`,
         [
           {
             text: 'Cancel',
             style: 'cancel',
             onPress: () => resolve(),
           },
           {
             text: 'Download',
             onPress: async () => {
               await openAppStore(platform);
               resolve();
             },
           },
         ]
       );
     });
   }
   ```

3. Update VideoControls handlers:
   ```typescript
   const handleTikTokShare = async () => {
     const result = await shareToTikTok(videoUri);

     if (!result.success) {
       if (result.appInstalled === false) {
         await showAppNotInstalledAlert('tiktok');
       } else {
         Alert.alert('Error', result.error || 'Failed to open TikTok');
       }
     }
   };

   // Similar for Instagram
   ```

**Acceptance:**
- [ ] Share functions return appInstalled status
- [ ] Alert shows when app not installed
- [ ] Alert offers "Download" button to app store
- [ ] Cancel button dismisses alert
- [ ] Other errors still show appropriate message
- [ ] Haptic feedback on alert buttons

---

### Task 3: ネイティブシェアシートへのフォールバックオプション

**Files:**
- `mobile/src/components/VideoControls.tsx` (modify)
- `mobile/src/components/ShareFallbackDialog.tsx` (new)

**Dependencies:** Task 2 (enhanced error handling)
**Creates:** Comprehensive fallback UX

**Steps:**
1. Create ShareFallbackDialog component:
   ```typescript
   interface ShareFallbackDialogProps {
     visible: boolean;
     platform: 'tiktok' | 'instagram';
     onNativeShare: () => void;
     onAppStore: () => void;
     onClose: () => void;
   }

   // Shows modal with 3 options:
   // 1. "Open App Store" → Download the app
   // 2. "Share via..." → Open native share sheet
   // 3. "Cancel" → Dismiss
   ```

2. Design dialog UI:
   - Modal presentation (bottom sheet on iOS, alert-like on Android)
   - Platform icon/logo (if available)
   - Clear, concise messaging
   - Primary action: "Download [Platform]"
   - Secondary action: "Share via..."
   - Cancel action: "Cancel"

3. Update VideoControls to use fallback dialog:
   ```typescript
   const [fallbackDialog, setFallbackDialog] = useState<{
     visible: boolean;
     platform: 'tiktok' | 'instagram' | null;
   }>({ visible: false, platform: null });

   const handleTikTokShare = async () => {
     const result = await shareToTikTok(videoUri);

     if (!result.success && result.appInstalled === false) {
       setFallbackDialog({ visible: true, platform: 'tiktok' });
     } else if (!result.success) {
       Alert.alert('Error', result.error || 'Failed to open TikTok');
     }
   };

   const handleNativeShare = async () => {
     setFallbackDialog({ visible: false, platform: null });
     const result = await shareVideo(videoUri);
     // ... handle result
   };

   const handleAppStore = async () => {
     const platform = fallbackDialog.platform;
     setFallbackDialog({ visible: false, platform: null });
     if (platform) {
       await openAppStore(platform);
     }
   };
   ```

4. Add styling:
   - Use consistent design language with rest of app
   - Platform-specific colors (TikTok black/cyan, Instagram gradient)
   - Smooth animations for modal presentation
   - Touch feedback on buttons

**Acceptance:**
- [ ] ShareFallbackDialog component created
- [ ] Dialog shows when app not installed
- [ ] "Download" button opens app store
- [ ] "Share via..." button opens native share sheet
- [ ] "Cancel" button dismisses dialog
- [ ] Dialog styling is consistent with app design
- [ ] Animations are smooth
- [ ] iOS and Android both work well

## Integration Testing

**Complete user flow:**
1. User generates video and views in VideoPlayer
2. User taps TikTok button:
   - If TikTok installed → Opens TikTok share screen
   - If TikTok NOT installed → Shows fallback dialog
     - Download → Opens App Store
     - Share via... → Opens native share sheet
     - Cancel → Returns to video player
3. User taps Instagram button:
   - Same flow as TikTok

## Testing

- **iOS with apps installed:** Verify direct sharing works
- **iOS without apps:** Verify fallback dialog appears
- **Android with apps installed:** Verify direct sharing works
- **Android without apps:** Verify fallback dialog appears
- **App Store link:** Verify opens correct app store page
- **Native share fallback:** Verify opens share sheet
- **Cancel flow:** Verify returns to video player
- **Edge cases:** Rapid button taps, backgrounding, network issues

## Rollback Strategy

- Remove ShareFallbackDialog if UX is confusing
- Keep simple Alert.alert if modal is too complex
- Always keep native share sheet as ultimate fallback

## Notes

- Prioritize native share sheet as the most reliable fallback
- App store links should open correct store (iOS App Store vs Google Play)
- Consider caching app installation status to avoid repeated checks
- Test on devices with and without social apps installed
- Monitor user behavior: do users prefer direct share or native share sheet?

## Future Enhancements

Out of scope for this phase but worth considering:

- Add other platforms (YouTube Shorts, Twitter/X, Facebook)
- Add "Share to All" button that opens native share sheet with pre-selected apps
- Add analytics tracking for share method preferences
- Add "Always use native share" setting for users who prefer it
- Cache installation status to improve performance

## Phase Completion Criteria

After completing both plans 07-01 and 07-02:

- [x] TikTok direct sharing works (when app installed)
- [x] Instagram direct sharing works (when app installed)
- [x] Fallback dialog appears when apps not installed
- [x] App store links work correctly
- [x] Native share sheet fallback works
- [x] Error handling is comprehensive
- [x] UI/UX is smooth and intuitive
- [x] Code is well-documented
- [x] Tests pass on iOS and Android

**Phase 07 is complete when all criteria above are met.**
