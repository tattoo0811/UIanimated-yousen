---
wave: 2
depends_on:
  - 02-01
files_modified:
  - mobile/src/components/SwipeableStack.tsx
  - mobile/src/lib/animations.ts
autonomous: true
---

# Plan 02-02: スワイプアニメーションの改善

## Objective

スワイプアニメーションを改善し、速度判定による自然なスワイプ判定、回転補間の最適化、次カードのスケール/フェードアニメーションの改善を実装する。これにより、60fpsで滑らかに動作する高品質なカードスワイプ体験を提供する。

## Context

### 現状の問題点
`mobile/src/components/SwipeableStack.tsx` の現在の実装には以下の問題がある:

1. **速度判定がない**: `event.velocityX`がチェックされていないため、速くスワイプしても反応しない場合がある
2. **回転補間の範囲が固定**: `interpolate`の入力範囲が`[-200, 200]`でハードコードされている
3. **contextがない**: `onStart`でcontextを初期化していないため、ドラッグ中にジャンプする可能性がある
4. **次カードのアニメーション**: スケールとフェードはあるが、より滑らかにできる

### 関連ファイル
- `mobile/src/components/SwipeableStack.tsx` - スワイプ可能なカードスタック
- `mobile/src/lib/animations.ts` - 新規作成: アニメーション定数の共有

### 技術スタック
- `react-native-reanimated` ~4.1.1 - UIスレッドでのアニメーション
- `react-native-gesture-handler` ~2.28.0 - ジェスチャー検出

## Success Criteria (must_haves)

1. [ ] 速くスワイプするとカードが飛び出す（velocity判定が機能する）
2. [ ] スワイプ中にカードが自然に回転する（補間が適切に機能する）
3. [ ] 次のカードがスムーズにスケールアップ/フェードインする
4. [ ] アニメーションが60fpsで動作する（カクつきがない）
5. [ ] 既存機能（無限ループ、選択/スキップ）が維持されている

## Tasks

### Task 1: アニメーション定数の共有ファイルを作成

アニメーションに関連する定数を一元管理するファイルを作成する。

**ファイル:** `mobile/src/lib/animations.ts`

```typescript
import { Dimensions } from 'react-native';

const SCREEN_WIDTH = Dimensions.get('window').width;

/**
 * Swipe animation constants
 */
export const SWIPE_CONFIG = {
  /** Distance threshold for swipe completion (25% of screen width) */
  THRESHOLD: SCREEN_WIDTH * 0.25,
  /** Velocity threshold for swipe completion (points per second) */
  VELOCITY_THRESHOLD: 800,
  /** Rotation interpolation range (degrees) */
  MAX_ROTATION: 15,
  /** Distance for animation calculation */
  ANIMATION_DISTANCE: SCREEN_WIDTH / 2,
  /** Spring animation config */
  SPRING_CONFIG: {
    damping: 20,
    stiffness: 300,
    mass: 1,
  },
  /** Scale range for next card */
  NEXT_CARD_SCALE: {
    min: 0.9,
    max: 1.0,
  },
  /** Opacity range for next card */
  NEXT_CARD_OPACITY: {
    min: 0.5,
    max: 1.0,
  },
} as const;
```

**検証:**
- [ ] ファイルが作成されている
- [ ] TypeScriptエラーがない

### Task 2: SwipeableStackのジェスチャーハンドラーを改善

速度判定、contextの追加、回転補間の改善を実装する。

**ファイル:** `mobile/src/components/SwipeableStack.tsx`

変更内容:

```typescript
// インポートに追加
import { SWIPE_CONFIG } from '../lib/animations';

// SwipeableStackコンポーネント内
export function SwipeableStack({ signs, onSwipeComplete, onSelect }: SwipeableStackProps) {
    const [currentIndex, setCurrentIndex] = useState(0);
    const translationX = useSharedValue(0);
    const contextX = useSharedValue(0);  // 追加: context for smooth dragging

    // 既存のコード...

    const pan = Gesture.Pan()
        .onStart(() => {
            'worklet';
            // contextを初期化してドラッグ中のジャンプを防ぐ
            contextX.value = translationX.value;
        })
        .onUpdate((event) => {
            'worklet';
            // contextからの相対位置を計算
            translationX.value = contextX.value + event.translationX;
        })
        .onEnd((event) => {
            'worklet';
            const isSwipeRight =
                event.translationX > SWIPE_CONFIG.THRESHOLD ||
                event.velocityX > SWIPE_CONFIG.VELOCITY_THRESHOLD;
            const isSwipeLeft =
                event.translationX < -SWIPE_CONFIG.THRESHOLD ||
                event.velocityX < -SWIPE_CONFIG.VELOCITY_THRESHOLD;

            if (isSwipeRight) {
                // Swipe Right - fly off to right
                translationX.value = withSpring(
                    SCREEN_WIDTH * 2,
                    SWIPE_CONFIG.SPRING_CONFIG,
                    () => {
                        runOnJS(handleSwipeComplete)('right');
                    }
                );
            } else if (isSwipeLeft) {
                // Swipe Left - fly off to left
                translationX.value = withSpring(
                    -SCREEN_WIDTH * 2,
                    SWIPE_CONFIG.SPRING_CONFIG,
                    () => {
                        runOnJS(handleSwipeComplete)('left');
                    }
                );
            } else {
                // Reset - spring back to center
                translationX.value = withSpring(0, SWIPE_CONFIG.SPRING_CONFIG);
            }
        });

    // アニメーションスタイルの改善
    const activeCardStyle = useAnimatedStyle(() => {
        // スクリーン幅に基づいた回転補間
        const rotate = interpolate(
            translationX.value,
            [-SWIPE_CONFIG.ANIMATION_DISTANCE, 0, SWIPE_CONFIG.ANIMATION_DISTANCE],
            [-SWIPE_CONFIG.MAX_ROTATION, 0, SWIPE_CONFIG.MAX_ROTATION],
            Extrapolation.CLAMP
        );

        return {
            transform: [
                { translateX: translationX.value },
                { rotate: `${rotate}deg` }
            ]
        };
    });

    // ... 既存のコード
}
```

**検証:**
- [ ] 速くスワイプするとカードが飛び出す
- [ ] ゆっくりスワイプして戻すとスプリングバックする
- [ ] 回転がスワイプ距離に応じて滑らかに変化する

### Task 3: 次カードのスケール/フェードアニメーションを改善

次のカードのアニメーションをより滑らかにする。

**ファイル:** `mobile/src/components/SwipeableStack.tsx`

変更内容:

```typescript
// 次カードのスタイル改善
const nextCardStyle = useAnimatedStyle(() => {
    // スワイプ距離に応じたスケール
    const scale = interpolate(
        Math.abs(translationX.value),
        [0, SWIPE_CONFIG.ANIMATION_DISTANCE / 2],  // より早く反応するように調整
        [SWIPE_CONFIG.NEXT_CARD_SCALE.min, SWIPE_CONFIG.NEXT_CARD_SCALE.max],
        Extrapolation.CLAMP
    );

    // スワイプ距離に応じた不透明度
    const opacity = interpolate(
        Math.abs(translationX.value),
        [0, SWIPE_CONFIG.ANIMATION_DISTANCE / 4],  // より早くフェードイン
        [SWIPE_CONFIG.NEXT_CARD_OPACITY.min, SWIPE_CONFIG.NEXT_CARD_OPACITY.max],
        Extrapolation.CLAMP
    );

    return {
        transform: [
            { scale }
        ],
        opacity: opacity
    };
});
```

**検証:**
- [ ] スワイプ開始と同時に次カードがフェードインし始める
- [ ] スケールアニメーションが滑らかである
- [ ] カードが奥から手前に浮き上がってくるような効果がある

## Verification

実機またはエミュレータで以下を検証:

1. [ ] **速度判定**: 速く右にスワイプするとカードが右に飛び出す
2. [ ] **速度判定**: 速く左にスワイプするとカードが左に飛び出す
3. [ ] **スプリングバック**: ゆっくりスワイプして戻すと、カードが中央に戻る
4. [ ] **回転**: スワイプ中にカードが自然に回転する
5. [ ] **次カード**: スワイプに応じて次カードがスケールアップする
6. [ ] **60fps**: アニメーション中にカクつきがない
7. [ ] **既存機能**: 無限ループが維持されている
8. [ ] **既存機能**: onSelectが正しく呼び出される

### パフォーマンス検証（任意）

React Native DevToolsで以下を確認:
- [ ] フレームレートが58-60fpsを維持している
- [ ] JSスレッドの負荷が高い状態になっていない

## Regression Testing

以下の既存機能が動作していることを確認:

1. [ ] 複数のカードを連続してスワイプできる
2. [ ] 最後のカードの後も最初のカードが表示される（無限ループ）
3. [ ] 右スワイプでonSelectが呼び出される
4. [ ] 左右のスワイプでonSwipeCompleteが呼び出される
5. [ ] SELECT/NEXTのインジケータが正しく表示される
