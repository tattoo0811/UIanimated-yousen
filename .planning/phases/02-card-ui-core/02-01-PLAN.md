---
wave: 1
depends_on: []
files_modified:
  - mobile/package.json
  - mobile/src/hooks/useHapticFeedback.ts
  - mobile/src/components/ZodiacCard.tsx
  - mobile/src/components/SwipeableStack.tsx
autonomous: true
---

# Plan 02-01: expo-haptics導入とタップフィードバックの実装

## Objective

expo-hapticsを導入し、カードタップ時の触覚フィードバックと視覚的アニメーションを実装する。これにより、ユーザーの操作に対する即座のフィードバックを提供し、アプリの応答性を向上させる。

## Context

### 現状
- `mobile/src/components/SwipeableStack.tsx` は既にスワイプジェスチャーを実装している
- `mobile/src/components/ZodiacCard.tsx` はカードのビジュアルデザインを実装している
- expo-hapticsは未導入

### 関連ファイル
- `mobile/package.json` - 依存関係管理
- `mobile/src/components/SwipeableStack.tsx` - スワイプ可能なカードスタック
- `mobile/src/components/ZodiacCard.tsx` - 個別のカードコンポーネント

### 技術スタック
- `expo-haptics` - iOS/Androidの触覚フィードバックAPI

## Success Criteria (must_haves)

1. [ ] expo-hapticsがインストールされ、ビルドが成功する
2. [ ] タップ時にLightインパクトの触覚フィードバックが発生する
3. [ ] タップ時にカードがスケールダウン/アップするアニメーションが表示される
4. [ ] スワイプ完了時にSuccess通知の触覚フィードバックが発生する
5. [ ] エミュレータ等ハプティクス非対応環境でクラッシュしない

## Tasks

### Task 1: expo-hapticsのインストール

expo-hapticsパッケージをインストールする。

```bash
cd mobile && npx expo install expo-haptics
```

**検証:**
- [ ] package.jsonにexpo-hapticsが追加されている
- [ ] `npm run typecheck`がエラーなしで通る

### Task 2: useHapticフックの作成

ハプティクスフィードバックを提供するカスタムフックを作成する。

**ファイル:** `mobile/src/hooks/useHapticFeedback.ts`

```typescript
import * as Haptics from 'expo-haptics';
import { Platform } from 'react-native';

export function useHapticFeedback() {
  const impact = (style: Haptics.ImpactFeedbackStyle = Haptics.ImpactFeedbackStyle.Medium) => {
    if (Platform.OS === 'ios' || Platform.OS === 'android') {
      Haptics.impactAsync(style).catch(() => {
        // Silently fail on unsupported devices/emulators
      });
    }
  };

  const light = () => impact(Haptics.ImpactFeedbackStyle.Light);
  const medium = () => impact(Haptics.ImpactFeedbackStyle.Medium);
  const heavy = () => impact(Haptics.ImpactFeedbackStyle.Heavy);

  const selection = () => {
    if (Platform.OS === 'ios' || Platform.OS === 'android') {
      Haptics.selectionAsync().catch(() => {});
    }
  };

  const notification = (type: Haptics.NotificationFeedbackType) => {
    if (Platform.OS === 'ios' || Platform.OS === 'android') {
      Haptics.notificationAsync(type).catch(() => {});
    }
  };

  const success = () => notification(Haptics.NotificationFeedbackType.Success);
  const warning = () => notification(Haptics.NotificationFeedbackType.Warning);
  const error = () => notification(Haptics.NotificationFeedbackType.Error);

  return {
    impact,
    light,
    medium,
    heavy,
    selection,
    notification,
    success,
    warning,
    error,
  };
}
```

**検証:**
- [ ] ファイルが作成されている
- [ ] TypeScriptエラーがない

### Task 3: ZodiacCardにタップアニメーションを追加

カードタップ時の視覚的フィードバックアニメーションを実装する。

**ファイル:** `mobile/src/components/ZodiacCard.tsx`

変更内容:
1. `react-native-reanimated`の`useSharedValue`, `useAnimatedStyle`, `withSpring`をインポート
2. `onPress`コールバックpropを追加
3. タップ時にスケールダウン/アップするアニメーションを実装
4. useHapticFeedbackを使用してタップ時に触覚フィードバックを発生

```typescript
// 追加するインポート
import { useSharedValue, useAnimatedStyle, withSpring } from 'react-native-reanimated';
import { GestureDetector, Gesture } from 'react-native-gesture-handler';
import { useHapticFeedback } from '../hooks/useHapticFeedback';

// ZodiacCardコンポーネント内に追加
interface ZodiacCardProps {
  sign: ZodiacSign;
  active?: boolean;
  onPress?: () => void;  // 追加
}

// コンポーネント内
export function ZodiacCard({ sign, active, onPress }: ZodiacCardProps) {
  const scale = useSharedValue(1);
  const { light } = useHapticFeedback();

  const tapGesture = Gesture.Tap()
    .onStart(() => {
      'worklet';
      scale.value = withSpring(0.95, { damping: 15, stiffness: 400 });
    })
    .onEnd(() => {
      'worklet';
      scale.value = withSpring(1, { damping: 15, stiffness: 400 });
      if (onPress) {
        runOnJS(onPress)();
      }
      runOnJS(light)();
    });

  const animatedStyle = useAnimatedStyle(() => ({
    transform: [{ scale: scale.value }],
  }));

  return (
    <GestureDetector gesture={tapGesture}>
      <Animated.View style={animatedStyle}>
        {/* 既存のカードコンテンツ */}
      </Animated.View>
    </GestureDetector>
  );
}
```

**検証:**
- [ ] タップ時にカードが縮小/復元するアニメーションが表示される
- [ ] タップ時に触覚フィードバックが発生する（実機のみ）

### Task 4: SwipeableStackにハプティクスフィードバックを追加

スワイプ完了時に触覚フィードバックを発生させる。

**ファイル:** `mobile/src/components/SwipeableStack.tsx`

変更内容:
1. useHapticFeedbackをインポート
2. handleSwipeComplete関数内でsuccess()を呼び出し

```typescript
// インポートに追加
import { useHapticFeedback } from '../hooks/useHapticFeedback';

// コンポーネント内
export function SwipeableStack({ signs, onSwipeComplete, onSelect }: SwipeableStackProps) {
  const { success, selection } = useHapticFeedback();

  const handleSwipeComplete = (direction: 'left' | 'right') => {
    // 右スワイプ（選択）時は成功フィードバック
    if (direction === 'right') {
      success();
      if (onSelect) {
        onSelect(activeCard);
      }
    } else {
      // 左スワイプ（スキップ）時は選択フィードバック
      selection();
    }
    if (onSwipeComplete) {
      onSwipeComplete(activeCard);
    }
    setCurrentIndex((prev) => prev + 1);
    translationX.value = 0;
  };

  // ... 既存のコード
}
```

**検証:**
- [ ] 右スワイプ時にSuccessハプティクスが発生する
- [ ] 左スワイプ時にSelectionハプティクスが発生する

## Verification

実機またはエミュレータで以下を検証:

1. [ ] カードをタップすると、カードが少し縮小して復元するアニメーションが表示される
2. [ ] タップ時にLightインパクトの振動が発生する（実機）
3. [ ] 右にスワイプして選択すると、Success通知の振動が発生する（実機）
4. [ ] 左にスワイプしてスキップすると、Selectionフィードバックが発生する（実機）
5. [ ] ハプティクス非対応環境（iOSシミュレータ等）でクラッシュしない
6. [ ] TypeScript型チェックが通る: `cd mobile && npm run typecheck`
