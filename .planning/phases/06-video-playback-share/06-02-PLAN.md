# Plan 06-02: expo-media-libraryによるカメラロール保存とexpo-sharingによるシェアシート

**Phase:** 06 - Video Playback & Share
**Wave:** 2 of 2
**Estimated:** 40-50 minutes
**Context:** ~50% (mobile app sharing, depends on 06-01)

## Goal

動画をカメラロールに保存し、ネイティブシェアシートから各アプリにシェアできる機能を実装する

## Success Criteria

1. 動画をカメラロールに保存できる（パーミッションリクエスト含む）
2. expo-sharingによるネイティブシェアシートが表示される
3. シェアシートから各アプリ（LINE、Twitter、Instagram等）にシェアできる
4. VideoPlayerコンポーネントに保存・シェアボタンが統合されている

## Prerequisites

- Plan 06-01 complete (VideoPlayer component exists)
- Expo SDK 54 environment

## Tasks

### Task 1: expo-media-libraryとexpo-sharingのインストールとパーミッション設定

**Files:**
- `mobile/app.json` (modify)
- `mobile/ios/Podfile` (modify - if needed)
- `mobile/src/lib/videoShare.ts` (new)

**Dependencies:** None
**Creates:** Video sharing library with permission handling

**Steps:**
1. Install packages:
   ```bash
   npx expo install expo-media-library expo-sharing
   npx expo install expo-file-system
   ```

2. Update `mobile/app.json` permissions:
   - iOS: NSPhotoLibraryAddUsageDescription
   - Android: WRITE_EXTERNAL_STORAGE permission
   - Android: READ_EXTERNAL_STORAGE permission

3. Create `mobile/src/lib/videoShare.ts`:
   - `saveToCameraRoll(videoUri: string): Promise<boolean>` function
   - Permission request handling with MediaLibrary.requestPermissionsAsync()
   - User-friendly permission denied alerts
   - `shareVideo(videoUri: string): Promise<boolean>` function using Sharing.shareAsync()
   - Error handling for each operation

**Implementation Details:**
```typescript
// videoShare.ts
export async function saveToCameraRoll(videoUri: string): Promise<{ success: boolean; error?: string }>
export async function shareVideo(videoUri: string): Promise<{ success: boolean; error?: string }>
export async function checkCameraRollPermissions(): Promise<boolean>
export async function requestCameraRollPermissions(): Promise<boolean>
```

**Acceptance:**
- [ ] Packages install without errors
- [ ] Permissions configured in app.json
- [ ] saveToCameraRoll function handles permission request
- [ ] shareVideo function opens native share sheet
- [ ] Error handling covers denied permissions

---

### Task 2: VideoPlayerコンポーネントへの保存・シェアボタン統合

**Files:**
- `mobile/src/components/VideoPlayer.tsx` (modify)
- `mobile/src/components/VideoControls.tsx` (new)

**Dependencies:** Task 1 (videoShare library)
**Creates:** Enhanced VideoPlayer with sharing UI

**Steps:**
1. Create `mobile/src/components/VideoControls.tsx`:
   - Download/Save button (icon: Download from lucide-react-native)
   - Share button (icon: Share from lucide-react-native)
   - Button positioning: Bottom right overlay on video
   - Loading states for save operation
   - Success/failure feedback with Toast or Alert
   - Animated button press feedback (expo-haptics)

2. Update `mobile/src/components/VideoPlayer.tsx`:
   - Import and use VideoControls component
   - Pass videoUri to controls
   - Handle save callback with success feedback
   - Handle share callback
   - Optional: Add `showControls?: boolean` prop to hide controls for embedded use

3. Update test screen `mobile/app/test-video.tsx`:
   - Verify save button saves to camera roll
   - Verify share button opens native share sheet
   - Test permission flow (deny → grant → retry)

**Implementation Details:**
```typescript
// VideoControls.tsx
interface VideoControlsProps {
  videoUri: string;
  onSave?: () => void;
  onShare?: () => void;
  disabled?: boolean;
}

// VideoPlayer.tsx integration
<VideoControls
  videoUri={currentVideoUri}
  onSave={handleSave}
  onShare={handleShare}
  disabled={isLoading}
/>
```

**Acceptance:**
- [ ] Save button triggers camera roll save
- [ ] Share button opens native share sheet
- [ ] Buttons show loading state during save operation
- [ ] Success feedback appears after save
- [ ] Error feedback appears on failure
- [ ] Haptic feedback on button press
- [ ] iOS and Android both work

---

### Task 3: キャッシュ管理の強化と結果画面への統合準備

**Files:**
- `mobile/src/lib/videoCache.ts` (modify)
- `mobile/src/lib/videoShare.ts` (modify)
- `mobile/src/types/index.ts` (modify)

**Dependencies:** Task 2 (VideoPlayer with controls)
**Creates:** Complete video sharing system

**Steps:**
1. Enhance `mobile/src/lib/videoCache.ts`:
   - Add `getCacheSize(): Promise<number>` function (total bytes)
   - Add `clearOldCache(maxAge: number): Promise<void>` function (remove files older than maxAge ms)
   - Add `clearAllCache(): Promise<void>` utility
   - AsyncStorage metadata: Map<url, {path: string, timestamp: number}>

2. Update `mobile/src/lib/videoShare.ts`:
   - Add cache integration: shareVideo checks cache first
   - If video is remote, cache before sharing
   - Return cached URI for sharing

3. Add types to `mobile/src/types/index.ts`:
   ```typescript
   export interface VideoMetadata {
     url: string;
     localPath?: string;
     cachedAt?: number;
     duration?: number;
     size?: number;
   }

   export interface VideoShareResult {
     success: boolean;
     method: 'camera-roll' | 'share-sheet';
     cached: boolean;
   }
   ```

4. Document usage in JSDoc comments:
   - How to use VideoPlayer component
   - Cache behavior and lifetime
   - Permission requirements

**Acceptance:**
- [ ] Cache size calculation works
- [ ] Old cache cleanup function works
- [ ] Share uses cached video if available
- [ ] Types are exported and usable
- [ ] JSDoc comments are complete

## Integration Notes for Future Phases

**For Phase 7 (Direct Social Sharing):**
- The `shareVideo` function can be extended with platform-specific URLs
- TikTok/Instagram deep links can be added here

**For result.tsx (Phase 5+ integration):**
- VideoPlayer can be imported and used with generated video URL
- Example:
  ```tsx
  import { VideoPlayer } from '@/components/VideoPlayer';
  <VideoPlayer src={generatedVideoUrl} autoPlay={true} />
  ```

## Testing

- **iOS:** Test permission flow (Settings → Privacy → Photos)
- **Android:** Test permission flow (Settings → Apps → Permissions)
- **Share Sheet:** Test LINE, Twitter, Instagram, Mail
- **Camera Roll:** Verify video appears in Photos app
- **Cache:** Test cache → close app → reopen → verify cache persists
- **Error Cases:** Test with no permissions, invalid URL, network offline

## Rollback Strategy

- Git revert of commits if sharing issues occur
- Uninstall expo-media-library and expo-sharing if needed

## Notes

- iOS requires explicit permission description in Info.plist (configured in app.json)
- Android 13+ (API 33) doesn't need storage permission for app-specific directories
- Cache size limit: Start with 100MB, add configurable limit in settings later
- Consider adding "Share to TikTok/Instagram" buttons in Phase 7
