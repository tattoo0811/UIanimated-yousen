# Plan 06-01: expo-videoによる動画再生機能の実装

**Phase:** 06 - Video Playback & Share
**Wave:** 1 of 2
**Estimated:** 40-50 minutes
**Context:** ~50% (mobile app video playback)

## Goal

生成された動画をアプリ内で再生できるビデオプレイヤーコンポーネントを実装する

## Success Criteria

1. `VideoPlayer`コンポーネントがexpo-videoを使用して動作する
2. 動画URLから再生、一時停止、シークが可能
3. ネイティブデバイスの全画面再生ボタンが表示される
4. 再生状態に応じたUIフィードバック（ローディング、エラー）がある

## Prerequisites

- Phase 05 complete (video generation API ready)
- Expo SDK 54 environment

## Tasks

### Task 1: expo-videoインストールとVideoPlayerコンポーネント作成

**File:** `mobile/src/components/VideoPlayer.tsx` (new)
**Dependencies:** None
**Creates:** VideoPlayer component

**Steps:**
1. Install expo-video package: `npx expo install expo-video`
2. Create `mobile/src/components/VideoPlayer.tsx` component with:
   - VideoView from expo-video for rendering
   - useVideo hook for playback control
   - Props interface: `src: string`, `style?: any`, `autoPlay?: boolean`
   - Loading state rendering with spinner
   - Error state with retry button
   - Native fullscreen button
3. TypeScript strict mode compliant types

**Implementation Details:**
```typescript
interface VideoPlayerProps {
  src: string;
  style?: any;
  autoPlay?: boolean;
  onEnd?: () => void;
  onError?: (error: Error) => void;
}
```

**Acceptance:**
- [ ] Component compiles without TypeScript errors
- [ ] Video loads and plays from provided URL
- [ ] Loading state shows during video fetch
- [ ] Error state displays if video fails to load

---

### Task 2: VideoPlayerの統合とキャッシュ機能追加

**File:** `mobile/src/lib/videoCache.ts` (new), `mobile/app/result.tsx` (modify)
**Dependencies:** Task 1 (VideoPlayer component)
**Creates:** Video caching system, integration screen

**Steps:**
1. Create `mobile/src/lib/videoCache.ts`:
   - Map<string, string> cache for URL → local file path
   - `getCachedVideo(url: string): Promise<string | null>` function
   - `cacheVideo(url: string): Promise<string>` function using FileSystem.downloadAsync
   - Cache key generation from URL hash
   - AsyncStorage for cache metadata persistence

2. Update `mobile/src/components/VideoPlayer.tsx`:
   - Add `useCache?: boolean` prop (default: true)
   - Check cache before playing video
   - Display cached indicator if video is from cache

3. Create test screen in `mobile/app/test-video.tsx`:
   - VideoPlayer component integration
   - Sample video URL input (public CDN video)
   - Play/pause controls
   - Cache status display

**Implementation Details:**
```typescript
// videoCache.ts
export async function getCachedVideo(url: string): Promise<string | null>
export async function cacheVideo(url: string): Promise<string>
export async function clearVideoCache(): Promise<void>
export function getCacheSize(): number

// VideoPlayer.tsx additions
const cachedUrl = useCache ? await getCachedVideo(src) : src;
```

**Acceptance:**
- [ ] Video downloads to local filesystem on first play
- [ ] Subsequent plays use cached file
- [ ] Cache persists across app restarts
- [ ] Test screen shows cache status (cached vs uncached)
- [ ] Clear cache function removes local files

## Testing

- Manual test with sample video URL (public CDN)
- Cache verification: Play video → Close app → Reopen → Play same video (should be instant)
- Error handling: Test with invalid URL
- iOS and Android verification

## Rollback Strategy

Git revert of commits if video playback issues occur
expo-video uninstall if needed

## Notes

- expo-video requires iOS 12+ and Android 5+ (already supported by Expo 54)
- Consider video preloading for better UX in future iterations
- Cache size limits should be monitored (add 100MB limit in Phase 6.2 if needed)
