---
phase: 05-video-content-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/compositions/HookComposition.tsx
  - backend/src/compositions/sections/ContentSections.tsx
  - backend/src/lib/contentGenerator.ts
  - backend/src/types/content.ts
autonomous: true

must_haves:
  truths:
    - "Video displays content sections in order: 本質 → 家族 → 仕事 → 恋愛 → オチ"
    - "Each section appears with transition effect between sections"
    - "Content is generated from fortune data (SanmeigakuInsenChart)"
    - "Final オチ section includes humorous closing message"
    - "Total video duration stays within 30 seconds (900 frames at 30fps)"
  artifacts:
    - path: "backend/src/lib/contentGenerator.ts"
      provides: "Content generation logic for 5 sections"
      exports: ["generateEssenceContent", "generateFamilyContent", "generateWorkContent", "generateLoveContent", "generateOchiContent"]
    - path: "backend/src/types/content.ts"
      provides: "Type definitions for video content sections"
      contains: "VideoContent, ContentSection"
    - path: "backend/src/compositions/sections/ContentSections.tsx"
      provides: "React components for each content section"
      exports: ["EssenceSection", "FamilySection", "WorkSection", "LoveSection", "OchiSection"]
    - path: "backend/src/compositions/HookComposition.tsx"
      provides: "Updated composition with 5-section structure"
      contains: "Sequence sections for each content type"
  key_links:
    - from: "backend/src/compositions/HookComposition.tsx"
      to: "backend/src/compositions/sections/ContentSections.tsx"
      via: "import statements and component usage"
      pattern: "import.*Section.*from.*sections"
    - from: "backend/src/compositions/HookComposition.tsx"
      to: "backend/src/lib/contentGenerator.ts"
      via: "function calls to generate content"
      pattern: "generate.*Content"
    - from: "backend/src/lib/contentGenerator.ts"
      to: "mobile/src/components/cards/*.tsx"
      via: "reference for content structure"
      pattern: "adviceMap.*stem"
---

<objective>
Implement 本質→家族→仕事→恋愛→オチ content structure with transition effects for personalized video narrative

**Purpose**: Create engaging video content that flows through 5 sections (essence, family, work, love, humorous conclusion) with smooth transitions between each section

**Output**:
- Content generation library with 5 section generators
- Content section components with transition effects
- Updated HookComposition with 5-section narrative flow
- Working video generation with complete content structure
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-video-content-integration/05-01-SUMMARY.md
@backend/src/compositions/HookComposition.tsx
@backend/src/compositions/TypingText.tsx
@backend/src/compositions/sections/TransitionEffect.tsx
@mobile/src/types/index.ts
@mobile/src/components/cards/FamilyCard.tsx
@mobile/src/components/cards/LoveCard.tsx
@mobile/src/components/cards/WorkCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content types and generation library</name>
  <files>
    - backend/src/types/content.ts
    - backend/src/lib/contentGenerator.ts
  </files>
  <action>
Create type definitions and content generation functions:

**File 1: backend/src/types/content.ts**
```typescript
import type {SanmeigakuInsenChart} from '../../../mobile/src/types';

export interface ContentSection {
  title: string;
  content: string;
  duration: number; // frames
}

export interface VideoContent {
  essence: ContentSection;    // 本質
  family: ContentSection;     // 家族
  work: ContentSection;       // 仕事
  love: ContentSection;       // 恋愛
  ochi: ContentSection;       // オチ
}

export interface ContentGeneratorParams {
  insen: SanmeigakuInsenChart;
  nickname: string;
  tone: 'TikTok' | 'YouTube' | 'Instagram';
}
```

**File 2: backend/src/lib/contentGenerator.ts**

Create 5 content generation functions based on mobile app card patterns:

1. **generateEssenceContent(insen, nickname, tone)**: 本質セクション
   - Returns title: "【{nickname}の本質】"
   - Content: 2-3 sentences about day stem characteristics (日干の特徴)
   - Reference: mobile/src/lib/yosen.ts for yangsen patterns
   - Duration: 120 frames (4 seconds)

2. **generateFamilyContent(insen, nickname, tone)**: 家族セクション
   - Returns title: "【家族運】"
   - Content: Based on getFamilyAdvice() pattern from mobile/src/components/cards/FamilyCard.tsx
   - Use adviceMap['甲'] through adviceMap['癸'] patterns
   - Duration: 90 frames (3 seconds)

3. **generateWorkContent(insen, nickname, tone)**: 仕事セクション
   - Returns title: "【仕事運】"
   - Content: Based on getWorkAdvice() from mobile/src/components/cards/WorkCard.tsx
   - Duration: 90 frames (3 seconds)

4. **generateLoveContent(insen, nickname, tone)**: 恋愛セクション
   - Returns title: "【恋愛運】"
   - Content: Based on getLoveAdvice() from mobile/src/components/cards/LoveCard.tsx
   - Duration: 90 frames (3 seconds)

5. **generateOchiContent(insen, nickname, tone)**: オチセクション
   - Returns title: "" (no title, just punchline)
   - Content: Humorous closing message (choose from 3-4 patterns based on day stem)
   - Example patterns:
     * "丙午最強伝説、始まってる！"
     * "今日もポジティブにいこうぜ！"
     * "運勢は乗りなさい！信じるものが救われるんじゃ！"
   - Duration: 60 frames (2 seconds)

IMPORTANT: Keep content concise for video format. Each section should be 1-3 short sentences maximum. Reference the mobile card components for advice patterns but shorten for video.
  </action>
  <verify>
- backend/src/types/content.ts exists with ContentSection, VideoContent, ContentGeneratorParams
- backend/src/lib/contentGenerator.ts exists with 5 generate functions
- Each function returns proper ContentSection with title, content, duration
- TypeScript compilation passes
  </verify>
  <done>
Content types and generation library created with 5 section generators based on mobile app patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ContentSections components with transition effects</name>
  <files>backend/src/compositions/sections/ContentSections.tsx</files>
  <action>
Create ContentSections.tsx with 5 section components:

Each section component should:
- Accept: title (string), content (string), speed (number), theme (ThemeConfig)
- Use TypingText for character-by-character display
- Use TransitionEffect for fade-in on section start
- Position content at appropriate vertical position (top: 40-60% range)
- Font size: 36-42px depending on content length

Component structure:
```typescript
import React from 'react';
import {AbsoluteFill} from 'remotion';
import {TypingText} from '../TypingText';
import {TransitionEffect} from './TransitionEffect';
import {useTheme} from '../themes/themeConfig';

interface SectionProps {
  title: string;
  content: string;
  speed: number;
  theme: 'KiraPop' | 'MonoEdge' | 'ZenWa';
}

export const EssenceSection: React.FC<SectionProps> = ({title, content, speed, theme}) => {
  const themeConfig = useTheme(theme);
  const transition = TransitionEffect({trigger: 0, duration: 15});

  return (
    <div style={{
      position: 'absolute',
      top: '40%',
      left: '50%',
      transform: 'translate(-50%, -50%)',
      width: '80%',
      opacity: transition.opacity,
    }}>
      {/* Title display if provided */}
      {title && (
        <div style={{fontSize: 32, fontWeight: 'bold', color: themeConfig.colors.primary, marginBottom: 20}}>
          {title}
        </div>
      )}
      <TypingText text={content} speed={speed} style={{fontSize: 38, color: themeConfig.colors.text, lineHeight: 1.6}} />
    </div>
  );
};

// Create similar components: FamilySection, WorkSection, LoveSection, OchiSection
// OchiSection should be centered vertically with larger font (48px)
```

IMPORTANT: All 5 sections in the same file. Export each component separately.
  </action>
  <verify>
- backend/src/compositions/sections/ContentSections.tsx exists
- Exports: EssenceSection, FamilySection, WorkSection, LoveSection, OchiSection
- Each component uses TypingText and TransitionEffect
- Proper positioning and styling for video format
  </verify>
  <done>
Content section components created with typing animation and transition effects
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate 5-section structure into HookComposition</name>
  <files>backend/src/compositions/HookComposition.tsx</files>
  <action>
Update HookComposition.tsx to implement 本質→家族→仕事→恋愛→オチ structure:

1. Add imports:
```typescript
import {EssenceSection, FamilySection, WorkSection, LoveSection, OchiSection} from './sections/ContentSections';
import {generateEssenceContent, generateFamilyContent, generateWorkContent, generateLoveContent, generateOchiContent} from '../lib/contentGenerator';
import type {SanmeigakuInsenChart} from '../../../mobile/src/types';
```

2. Update props interface to accept insen data:
```typescript
interface HookCompositionProps {
  nickname: string;
  fortuneData: {
    result: string;
    rating: number;
    insen?: SanmeigakuInsenChart;  // Add this
  };
  theme: 'KiraPop' | 'MonoEdge' | 'ZenWa';
  tone: 'TikTok' | 'YouTube' | 'Instagram';
}
```

3. Generate content at component start:
```typescript
const content = fortuneData.insen ? {
  essence: generateEssenceContent(fortuneData.insen, nickname, tone),
  family: generateFamilyContent(fortuneData.insen, nickname, tone),
  work: generateWorkContent(fortuneData.insen, nickname, tone),
  love: generateLoveContent(fortuneData.insen, nickname, tone),
  ochi: generateOchiContent(fortuneData.insen, nickname, tone),
} : null;
```

4. Replace 5-15s section with 5-section Sequence structure:
```typescript
{content && (
  <>
    {/* 5-9s (120 frames): 本質 */}
    <Sequence from={150} durationInFrames={120}>
      <EssenceSection
        title={content.essence.title}
        content={content.essence.content}
        speed={themeConfig.animations.typingSpeed}
        theme={theme}
      />
    </Sequence>

    {/* 9-12s (90 frames): 家族 */}
    <Sequence from={270} durationInFrames={90}>
      <FamilySection {...} />
    </Sequence>

    {/* 12-15s (90 frames): 仕事 */}
    <Sequence from={360} durationInFrames={90}>
      <WorkSection {...} />
    </Sequence>

    {/* 15-18s (90 frames): 恋愛 */}
    <Sequence from={450} durationInFrames={90}>
      <LoveSection {...} />
    </Sequence>

    {/* 18-20s (60 frames): オチ */}
    <Sequence from={540} durationInFrames={60}>
      <OchiSection {...} />
    </Sequence>
  </>
)}
```

5. Keep 0-2s visual hook, 2-5s nickname, 20-30s CTA/branding sections unchanged

IMPORTANT: Total timing must stay within 900 frames (30 seconds). Adjust section durations if needed to fit within limit.
  </action>
  <verify>
- HookComposition imports 5 section components and 5 content generators
- Props interface includes insen data field
- Content generation happens at component level
- 5-20s section replaced with 5 Sequence sections
- Total video duration: ~600 frames (20s) for content + 300 frames (10s) for hook/CTA/branding
- TypeScript compilation passes
  </verify>
  <done>
HookComposition updated with complete 本質→家族→仕事→恋愛→オチ structure
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. **File Structure Check**:
```bash
ls -la backend/src/lib/contentGenerator.ts
ls -la backend/src/types/content.ts
ls -la backend/src/compositions/sections/ContentSections.tsx
```

2. **TypeScript Compilation**:
```bash
cd backend
npx tsc --noEmit
# Should complete without errors
```

3. **Import Verification**:
```bash
grep -n "generate.*Content" backend/src/compositions/HookComposition.tsx
# Should show all 5 content generators imported
grep -n "Section" backend/src/compositions/HookComposition.tsx
# Should show all 5 section components used
```

4. **Schema Update**:
Update backend/src/compositions/HookComposition.tsx hookCompositionSchema to include optional insen field:
```typescript
fortuneData: z.object({
  result: z.string().max(200),
  rating: z.number().min(1).max(5),
  insen: z.any().optional(),  // Add this for flexibility
})
```
</verification>

<success_criteria>
Success criteria met when:
- [ ] Content types defined (VideoContent, ContentSection)
- [ ] 5 content generation functions exist (essence, family, work, love, ochi)
- [ ] 5 section components exist with transition effects
- [ ] HookComposition uses 5-section Sequence structure
- [ ] Total video duration stays within 30 seconds
- [ ] Content flows from 本質 → 家族 → 仕事 → 恋愛 → オチ
- [ ] TypeScript compilation passes
- [ ] Schema supports insen data input
</success_criteria>

<output>
After completion, create `.planning/phases/05-video-content-integration/05-02-SUMMARY.md`
</output>
