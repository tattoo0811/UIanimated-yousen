---
phase: 04-video-generation-backend
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - backend/src/compositions/TypingText.tsx
  - backend/src/compositions/HookComposition.tsx
autonomous: true

user_setup: []

must_haves:
  truths:
    - "TypingText component implements character-by-character animation using interpolate()"
    - "HookComposition uses Sequence components for 5 timed sections (0-2s, 2-5s, 5-15s, 15-20s, 20-30s)"
    - "7-second hook composition is implemented (visual hook, personalization, revelation, CTA, branding)"
    - "Typing effect is applied to nickname and fortune result sections"
  artifacts:
    - path: "backend/src/compositions/TypingText.tsx"
      provides: "Typing animation component"
      exports: ["TypingText"]
      contains: "useCurrentFrame", "interpolate"
    - path: "backend/src/compositions/HookComposition.tsx"
      provides: "Composition with hook structure"
      contains: "Sequence.*from.*0", "Sequence.*from.*60", "Sequence.*from.*150", "Sequence.*from.*450", "Sequence.*from.*600"
  key_links:
    - from: "backend/src/compositions/HookComposition.tsx"
      to: "backend/src/compositions/TypingText.tsx"
      via: "import TypingText"
      pattern: "import.*TypingText"
    - from: "backend/src/compositions/HookComposition.tsx"
      to: "backend/src/compositions/themes/themeConfig.ts"
      via: "useTheme hook for typingSpeed"
      pattern: "useTheme.*typingSpeed"
    - from: "backend/src/compositions/TypingText.tsx"
      to: "remotion"
      via: "useCurrentFrame, interpolate imports"
      pattern: "import.*useCurrentFrame.*interpolate"
---

<objective>
Implement 7-second hook composition with typing effect animations.

**Purpose:** Create the 7-second hook structure (visual hook → personalization → revelation → CTA → branding) with character-by-character text animation using Remotion's Sequence and interpolate() patterns.

**Output:** TypingText component with frame-based animation, HookComposition with 5 Sequence-timed sections using typing effect for nickname and fortune result.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-generation-backend/04-CONTEXT.md
@.planning/phases/04-video-generation-backend/04-RESEARCH.md

# Prior work
- 04-01: Backend setup, HookComposition stub
- 04-02: VideoTemplate base component, theme system

# Research references
- Typing effect pattern: Sequence + interpolate(), useCurrentFrame(), text.slice(0, charsToShow)
- Hook composition: 0-2s visual hook, 2-5s personalization, 5-15s revelation, 15-20s CTA, 20-30s branding
- Cursor blink: interpolate(frame % 30, [0, 15, 30], [1, 0, 1])
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypingText component with interpolate()</name>
  <files>backend/src/compositions/TypingText.tsx</files>
  <action>
Create **backend/src/compositions/TypingText.tsx**:

```typescript
import React from 'react';
import {useCurrentFrame, useVideoConfig, interpolate} from 'remotion';

interface TypingTextProps {
  text: string;
  speed?: number;  // characters per second (default: 15)
  style?: React.CSSProperties;
}

export const TypingText: React.FC<TypingTextProps> = ({
  text,
  speed = 15,
  style = {},
}) => {
  const frame = useCurrentFrame();
  const {fps} = useVideoConfig();

  // Calculate how many characters should be visible
  const charsPerSecond = speed;
  const charsToShow = Math.floor((frame / fps) * charsPerSecond);

  // Slice text progressively
  const visibleText = text.slice(0, charsToShow);

  // Optional: Cursor blink effect
  const showCursor = interpolate(frame % 30, [0, 15, 30], [1, 0, 1]);

  return (
    <div style={style}>
      {visibleText}
      <span style={{opacity: showCursor, marginLeft: 2}}>▋</span>
    </div>
  );
};
```

Why:
- useCurrentFrame() provides current frame number for animation timing
- charsToShow calculation: (frame / fps) * speed = characters visible at current time
- text.slice(0, charsToShow) progressively reveals text character-by-character
- Cursor blink effect using interpolate() with modulo operation (frame % 30 creates 0-29 cycle)
- Default speed 15 chars/sec matches standard typing (configurable per theme)

Reference:
- Typing effect pattern from 04-RESEARCH.md: useCurrentFrame(), interpolate(), text.slice()
- Cursor blink pattern: interpolate(frame % 30, [0, 15, 30], [1, 0, 1])
  </action>
  <verify>
```bash
cd backend && grep -n "useCurrentFrame" src/compositions/TypingText.tsx
cd backend && grep -n "interpolate" src/compositions/TypingText.tsx
cd backend && grep -n "text.slice" src/compositions/TypingText.tsx
cd backend && grep -n "frame % 30" src/compositions/TypingText.tsx
```
  </verify>
  <done>
backend/src/compositions/TypingText.tsx exports TypingText component
TypingText uses useCurrentFrame() and fps to calculate character visibility
Character-by-character animation implemented with text.slice(0, charsToShow)
Cursor blink effect created with interpolate(frame % 30, [0, 15, 30], [1, 0, 1])
Default speed parameter set to 15 characters per second
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 7-second hook composition with Sequence</name>
  <files>backend/src/compositions/HookComposition.tsx</files>
  <action>
Update **backend/src/compositions/HookComposition.tsx**:

```typescript
import React from 'react';
import {AbsoluteFill, Sequence} from 'remotion';
import {z} from 'zod';
import {VideoTemplate} from './VideoTemplate';
import {TypingText} from './TypingText';
import {useTheme} from './themes/themeConfig';

export const hookCompositionSchema = z.object({
  nickname: z.string().max(20),
  fortuneData: z.object({
    result: z.string().max(200),
    rating: z.number().min(1).max(5),
  }),
  theme: z.enum(['KiraPop', 'MonoEdge', 'ZenWa']),
  tone: z.enum(['TikTok', 'YouTube', 'Instagram']),
});

interface HookCompositionProps {
  nickname: string;
  fortuneData: {
    result: string;
    rating: number;
  };
  theme: 'KiraPop' | 'MonoEdge' | 'ZenWa';
  tone: 'TikTok' | 'YouTube' | 'Instagram';
}

export const HookComposition: React.FC<HookCompositionProps> = ({
  nickname,
  fortuneData,
  theme,
}) => {
  const themeConfig = useTheme(theme);

  return (
    <VideoTemplate theme={theme}>
      <AbsoluteFill>
        {/* 0-2s (60 frames): Visual Hook - attention-grabbing visuals */}
        <Sequence from={0} durationInFrames={60}>
          <div style={{
            position: 'absolute',
            top: '10%',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: 72,
            fontWeight: 'bold',
            color: themeConfig.colors.primary,
            textAlign: 'center',
          }}>
            運勢診断
          </div>
        </Sequence>

        {/* 2-5s (90 frames): Personalization - nickname typing */}
        <Sequence from={60} durationInFrames={90}>
          <div style={{
            position: 'absolute',
            top: '30%',
            left: '50%',
            transform: 'translateX(-50%)',
            width: '80%',
            textAlign: 'center',
          }}>
            <TypingText
              text={`${nickname}さんの運勢`}
              speed={themeConfig.animations.typingSpeed}
              style={{
                fontSize: 48,
                fontWeight: 'bold',
                color: themeConfig.colors.primary,
              }}
            />
          </div>
        </Sequence>

        {/* 5-15s (300 frames): Revelation - fortune typing */}
        <Sequence from={150} durationInFrames={300}>
          <div style={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            width: '80%',
            textAlign: 'center',
          }}>
            <TypingText
              text={fortuneData.result}
              speed={themeConfig.animations.typingSpeed}
              style={{
                fontSize: fortuneData.result.length > 100 ? 36 : 48,
                color: themeConfig.colors.text,
                lineHeight: 1.6,
              }}
            />
          </div>
        </Sequence>

        {/* 15-20s (150 frames): CTA - call to action */}
        <Sequence from={450} durationInFrames={150}>
          <div style={{
            position: 'absolute',
            bottom: '20%',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: 32,
            color: themeConfig.colors.accent,
            textAlign: 'center',
          }}>
            シェアして友達に見せよう！
          </div>
        </Sequence>

        {/* 20-30s (300 frames): Branding - brand elements */}
        <Sequence from={600} durationInFrames={300}>
          <div style={{
            position: 'absolute',
            bottom: '5%',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: 24,
            opacity: 0.7,
          }}>
            陰陽五行アプリ
          </div>
        </Sequence>
      </AbsoluteFill>
    </VideoTemplate>
  );
};
```

Why:
- Sequence components create 5 timed sections: 0-2s (60 frames), 2-5s (90 frames), 5-15s (300 frames), 15-20s (150 frames), 20-30s (300 frames)
- Frame calculations based on 30fps: durationInFrames = seconds * 30
- from parameter specifies start frame for each Sequence (cumulative: 0, 60, 150, 450, 600)
- TypingText used in personalization (2-5s) and revelation (5-15s) sections
- Dynamic font sizing for long fortune results (>100 chars uses 36px vs 48px)
- Theme-specific styling via useTheme hook (colors, typingSpeed)
- AbsoluteFill for full-screen layout, absolute positioning for section placement

Reference:
- 7-second hook structure from 04-CONTEXT.md: 0-2s visual hook, 2-5s personalization, 5-15s revelation, 15-20s CTA, 20-30s branding
- Sequence timing: from={frame} durationInFrames={n} (04-RESEARCH.md)
- Dynamic font sizing for text overflow prevention (04-RESEARCH.md pitfall #4)
- Video format: 30fps, 900 frames total (30 seconds)

Note:
- Sequence timing matches 7-second hook specification exactly
- Total duration: 900 frames (30 seconds @ 30fps)
- Nickname typing uses faster theme-specific typingSpeed
- Fortune result section uses dynamic font sizing to prevent overflow
  </action>
  <verify>
```bash
cd backend && grep -n "Sequence.*from.*0" src/compositions/HookComposition.tsx
cd backend && grep -n "Sequence.*from.*60" src/compositions/HookComposition.tsx
cd backend && grep -n "Sequence.*from.*150" src/compositions/HookComposition.tsx
cd backend && grep -n "Sequence.*from.*450" src/compositions/HookComposition.tsx
cd backend && grep -n "Sequence.*from.*600" src/compositions/HookComposition.tsx
cd backend && grep -n "TypingText" src/compositions/HookComposition.tsx
cd backend && grep -n "useTheme" src/compositions/HookComposition.tsx
```
  </verify>
  <done>
HookComposition uses Sequence components for 5 sections (0-2s, 2-5s, 5-15s, 15-20s, 20-30s)
Sequence timing: from={0, 60, 150, 450, 600} with durationInFrames={60, 90, 300, 150, 300}
TypingText component used for nickname (2-5s) and fortune result (5-15s) sections
Theme-specific typingSpeed applied via useTheme hook
Dynamic font sizing for fortune results (>100 chars uses 36px, otherwise 48px)
All sections use themeConfig.colors for styling (primary, text, accent)
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. **TypingText component is valid:**
```bash
cd backend && npx tsc --noEmit
```

2. **Sequence sections are correctly timed:**
```bash
cd backend && grep -A 2 "Sequence from" src/compositions/HookComposition.tsx | grep -E "from=|durationInFrames="
```

3. **TypingText is imported and used:**
```bash
cd backend && grep "import.*TypingText" src/compositions/HookComposition.tsx
cd backend && grep "<TypingText" src/compositions/HookComposition.tsx
```
</verification>

<success_criteria>
Phase 04-03 is complete when:
- backend/src/compositions/TypingText.tsx exports TypingText component with useCurrentFrame() and interpolate()
- TypingText implements character-by-character animation using text.slice(0, charsToShow)
- Cursor blink effect exists using interpolate(frame % 30, [0, 15, 30], [1, 0, 1])
- HookComposition uses Sequence for 5 sections (0-2s, 2-5s, 5-15s, 15-20s, 20-30s)
- TypingText used in personalization (2-5s) and revelation (5-15s) sections
- Theme-specific typingSpeed applied via useTheme hook
- Dynamic font sizing for long fortune results (>100 chars uses 36px)
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-generation-backend/04-03-SUMMARY.md`
</output>
