---
phase: 04-video-generation-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/src/index.ts
  - backend/Dockerfile
  - backend/.gitignore
  - backend/.env.example
autonomous: true

user_setup:
  - service: google-cloud
    why: "Cloud Run deployment for Remotion video rendering service"
    env_vars:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        source: "GCP Console -> IAM & Admin -> Service Accounts -> Create Service Account -> Download JSON key"
      - name: GCP_PROJECT_ID
        source: "GCP Console project ID"
      - name: GCP_REGION
        source: "GCP region (e.g., us-central1)"
    dashboard_config:
      - task: "Enable Cloud Run API"
        location: "GCP Console -> APIs & Services -> Library -> Cloud Run API -> Enable"
      - task: "Enable Cloud Storage API"
        location: "GCP Console -> APIs & Services -> Library -> Cloud Storage JSON API -> Enable"
      - task: "Enable Cloud Build API"
        location: "GCP Console -> APIs & Services -> Library -> Cloud Build API -> Enable"

must_haves:
  truths:
    - "Node.js backend project structure exists with TypeScript configuration"
    - "Remotion core dependencies are installed (remotion, @remotion/cloudrun, @remotion/bundler)"
    - "Dockerfile is configured for Cloud Run deployment"
    - "Environment variable template exists for GCP credentials"
  artifacts:
    - path: "backend/package.json"
      provides: "Remotion dependencies and scripts"
      contains: "\"remotion\": \"^4.0\""
    - path: "backend/src/index.ts"
      provides: "Remotion entry point"
      exports: ["Composition", "registerRoot"]
    - path: "backend/Dockerfile"
      provides: "Container image for Cloud Run"
      min_lines: 15
    - path: "backend/.env.example"
      provides: "Environment variable template"
      contains: "GCP_PROJECT_ID"
  key_links:
    - from: "backend/package.json"
      to: "remotion, @remotion/cloudrun"
      via: "npm install"
      pattern: "remotion.*4\\.0"
    - from: "backend/Dockerfile"
      to: "Cloud Run deployment"
      via: "deployService() from @remotion/cloudrun"
      pattern: "FROM.*node"
---

<objective>
Create Remotion backend project structure with Cloud Run integration.

**Purpose:** Establish the foundation for server-side video rendering on Google Cloud Platform using Remotion's official Cloud Run integration.

**Output:** Working Node.js backend with Remotion, Dockerfile for Cloud Run, environment configuration for GCP deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-generation-backend/04-CONTEXT.md
@.planning/phases/04-video-generation-backend/04-RESEARCH.md

# Research references
- Standard stack: remotion 4.0+, @remotion/cloudrun 4.0.399+, @remotion/bundler
- Resource requirements: 2 vCPU / 2GiB memory, 300s timeout
- Deployment pattern: deployService(), deploySite(), getOrCreateBucket()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize backend project structure</name>
  <files>backend/package.json, backend/tsconfig.json, backend/.gitignore</files>
  <action>
Create backend directory structure:

```bash
mkdir -p backend/src
cd backend
npm init -y
```

Create **backend/package.json** with:

```json
{
  "name": "fortune-video-backend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "remotion studio",
    "build": "remotion bundle",
    "start": "node bundle.js"
  },
  "dependencies": {
    "remotion": "^4.0.161",
    "@remotion/cloudrun": "^4.0.399",
    "@remotion/cloudrun/client": "^4.0.399",
    "@remotion/bundler": "^4.0.161",
    "@remotion/zod-types": "^4.0.161",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "zod": "^3.22.4"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "typescript": "^5.3.3"
  }
}
```

Create **backend/tsconfig.json**:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

Create **backend/.gitignore**:

```
node_modules/
bundle.js
dist/
.env
.env.local
*.log
.DS_Store
```

Why:
- package.json defines Remotion 4.0+ dependencies for Cloud Run integration
- tsconfig.json enables strict TypeScript with ES2022 modules for Node.js 18+
- .gitignore excludes build artifacts and environment files
  </action>
  <verify>
```bash
cd backend && cat package.json | grep "remotion.*4\\.0"
cd backend && cat tsconfig.json | grep "strict.*true"
cd backend && ls -la .gitignore
```
  </verify>
  <done>
backend/package.json contains remotion ^4.0, @remotion/cloudrun ^4.0.399
backend/tsconfig.json has strict mode enabled and ES2022 target
backend/.gitignore excludes node_modules, bundle.js, .env files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Remotion entry point and Dockerfile</name>
  <files>backend/src/index.ts, backend/Dockerfile, backend/.env.example</files>
  <action>
Create **backend/src/index.ts** (Remotion root):

```typescript
import {Composition} from 'remotion';
import {HookComposition} from './compositions/HookComposition';

export const RemotionRoot: React.FC = () => {
  return (
    <>
      <Composition
        id="HookComposition"
        component={HookComposition}
        durationInFrames={900}  // 30 seconds @ 30fps
        fps={30}
        width={1080}   // 9:16 vertical
        height={1920}
        defaultProps={{
          nickname: 'テストユーザー',
          fortuneData: {
            result: '今日は幸運な一日でしょう！',
            rating: 5,
          },
          theme: 'KiraPop',
          tone: 'TikTok',
        }}
      />
    </>
  );
};
```

Create **backend/src/compositions/HookComposition.tsx** (stub):

```typescript
import {z} from 'zod';
import {zColor} from '@remotion/zod-types';

export const hookCompositionSchema = z.object({
  nickname: z.string().max(20),
  fortuneData: z.object({
    result: z.string().max(200),
    rating: z.number().min(1).max(5),
  }),
  theme: z.enum(['KiraPop', 'MonoEdge', 'ZenWa']),
  tone: z.enum(['TikTok', 'YouTube', 'Instagram']),
});

export const HookComposition: React.FC<z.infer<typeof hookCompositionSchema>> = ({
  nickname,
  fortuneData,
  theme,
}) => {
  return (
    <div style={{
      backgroundColor: '#000',
      color: '#fff',
      width: '100%',
      height: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      fontSize: 48,
    }}>
      {nickname}さんの{theme}テーマ動画
    </div>
  );
};
```

Create **backend/Dockerfile** for Cloud Run:

```dockerfile
# Use Node.js 18 LTS
FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 remotion

COPY --from=builder /app/bundle.js ./bundle.js
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

USER remotion

EXPOSE 8080

ENV PORT 8080

CMD ["npm", "start"]
```

Create **backend/.env.example**:

```bash
# GCP Configuration
GCP_PROJECT_ID=your-project-id
GCP_REGION=us-central1

# Cloud Run Service
REMOTION_SERVICE_NAME=remotion-render-service
REMOTION_SERVE_URL=https://your-site-url

# Cloud Storage
GCS_BUCKET_NAME=remotioncloudrun-xxxxx

# API Configuration
PORT=8080
NODE_ENV=production
```

Why:
- index.ts exports RemotionRoot with HookComposition (9:16, 30fps, 900 frames)
- HookComposition.tsx provides Zod schema validation and stub component
- Dockerfile follows multi-stage build pattern for Cloud Run (Node.js 18 Alpine)
- .env.example documents required GCP environment variables

Reference:
- Video format: 9:16 (1080x1920), 30fps, 30 seconds (04-CONTEXT.md)
- Resource requirements: 2 vCPU / 2GiB (04-RESEARCH.md)
  </action>
  <verify>
```bash
cd backend && grep -n "Composition.*HookComposition" src/index.ts
cd backend && grep -n "hookCompositionSchema" src/compositions/HookComposition.tsx
cd backend && grep -n "FROM.*node:18" Dockerfile
cd backend && grep -n "GCP_PROJECT_ID" .env.example
```
  </verify>
  <done>
backend/src/index.ts exports RemotionRoot with HookComposition configured for 9:16 video (1080x1920, 30fps, 900 frames)
backend/src/compositions/HookComposition.tsx contains Zod schema with nickname, fortuneData, theme, tone validation
backend/Dockerfile uses multi-stage build with Node.js 18 Alpine base image
backend/.env.example contains all required GCP environment variables (PROJECT_ID, REGION, BUCKET_NAME)
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. **Project structure exists:**
```bash
ls -la backend/
ls -la backend/src/
ls -la backend/src/compositions/
```

2. **Dependencies can be installed:**
```bash
cd backend && npm install --dry-run
```

3. **TypeScript configuration is valid:**
```bash
cd backend && npx tsc --noEmit
```

4. **Dockerfile syntax is valid:**
```bash
cd backend && docker build --dry-run -f Dockerfile .
```
</verification>

<success_criteria>
Phase 04-01 is complete when:
- backend/ directory exists with package.json, tsconfig.json, Dockerfile
- Remotion dependencies (remotion ^4.0, @remotion/cloudrun ^4.0.399) are defined
- src/index.ts exports RemotionRoot with HookComposition (9:16, 30fps, 900 frames)
- src/compositions/HookComposition.tsx contains Zod schema validation
- Dockerfile is configured for Cloud Run deployment (Node.js 18, multi-stage build)
- .env.example documents GCP environment variables
- All files pass TypeScript compilation check
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-generation-backend/04-01-SUMMARY.md`
</output>
