---
phase: 01-foundation-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/src/types/index.ts
  - mobile/src/lib/storage/schema.ts
  - mobile/src/lib/storage/migrations.ts
  - mobile/src/lib/cache.ts
  - mobile/src/lib/monitoring.ts
  - mobile/src/lib/share.ts
  - mobile/src/lib/notifications.ts
  - mobile/src/components/cards/FamilyCard.tsx
  - mobile/src/components/cards/LoveCard.tsx
  - mobile/src/components/cards/WorkCard.tsx
  - mobile/app/settings.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TypeScript strict modeで型エラーが発生しない"
    - "any型が適切な型に置き換えられている"
    - "ビルドがTypeScriptエラーなく通過する"
  artifacts:
    - path: "mobile/src/types/index.ts"
      provides: "型定義"
      contains: "Record<string, unknown>" instead of "Record<string, any>"
    - path: "mobile/src/lib/storage/schema.ts"
      provides: "ストレージスキーマ型定義"
      contains: "FortuneResult type with proper resultData type"
    - path: "mobile/src/lib/cache.ts"
      provides: "メモ化キャッシュ"
      contains: "proper generic types without any"
  key_links:
    - from: "mobile/src/lib/storage/schema.ts"
      to: "mobile/src/types/index.ts"
      via: "FortuneResult.resultData should use CalculationResult type"
      pattern: "resultData.*CalculationResult"
    - from: "mobile/src/lib/cache.ts"
      to: "mobile/src/types/index.ts"
      via: "memoizeSimple generic constraints"
      pattern: "extends.*Args.*unknown"
---

<objective>
TypeScript strict modeで型エラーを修正し、型安全性を向上させる

Purpose: 既存コードベースの`any`型使用を適切な型に置き換え、strict mode下で型エラーが発生しない状態にする。これにより、リファクタリング時の安全性を向上させ、バグを早期発見可能にする。
Output: 型エラーのない状態、`any`型の削除、適切な型定義の追加
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-code-quality/01-RESEARCH.md

# Current Type Issues
@mobile/src/types/index.ts - Contains Record<string, any> at line 137
@mobile/src/lib/storage/schema.ts - Contains resultData: any at line 23
@mobile/src/lib/cache.ts - Uses any[] at line 10
@mobile/src/lib/monitoring.ts - Uses Record<string, any> at line 38
@mobile/src/lib/share.ts - Uses any for error at line 132
@mobile/src/lib/storage/migrations.ts - Uses any at lines 7, 45
</context>

<tasks>

<task type="auto">
  <name>Task 1: types/index.tsのany型を修正</name>
  <files>mobile/src/types/index.ts</files>
  <action>
    SanmeigakuInsenChart.extensionsの型を`Record<string, any>`から`Record<string, unknown>`に変更。
    理由: `any`は型安全性を完全に無視するため、`unknown`を使用して型ガードを強制する方が安全。
  </action>
  <verify>npx tsc --noEmit | grep -i "types/index.ts" returns no errors</verify>
  <done>SanmeigakuInsenChart.extensionsがunknown型を使用し、型エラーが解消されている</done>
</task>

<task type="auto">
  <name>Task 2: lib/storage/schema.tsの型定義を強化</name>
  <files>mobile/src/lib/storage/schema.ts</files>
  <action>
    FortuneResult.resultDataの型を`any`から適切な型に変更。
    1. types/index.tsのCalculationResult型をimport
    2. FortuneResult.resultDataを`CalculationResult | null`に変更
    3. 既存データとの互換性を考慮し、resultDataはオプショナルにする
  </action>
  <verify>npx tsc --noEmit | grep -i "schema.ts" returns no errors</verify>
  <done>FortuneResult.resultDataがCalculationResult型を使用し、型安全性が確保されている</done>
</task>

<task type="auto">
  <name>Task 3: lib/cache.tsのany型を修正</name>
  <files>mobile/src/lib/cache.ts</files>
  <action>
    memoizeSimple関数のジェネリック制約を修正。
    1. `...args: any[]`を`...args: unknown[]`に変更
    2. JSON.stringifyの使用を維持（キャッシュキー生成には妥当）
    3. 必要に応じて型ガードを追加
  </action>
  <verify>npx tsc --noEmit | grep -i "cache.ts" returns no errors</verify>
  <done>memoizeSimple関数がunknown型を使用し、型安全性が向上している</done>
</task>

<task type="auto">
  <name>Task 4: lib/monitoring.tsのany型を修正</name>
  <files>mobile/src/lib/monitoring.ts</files>
  <action>
    recordErrorメソッドのcontextパラメータ型を`Record<string, any>`から`Record<string, string | number | boolean>`に変更。
    理由: Firebase Crashlyticsに渡す属性はプリミティブ型のみが有効。
  </action>
  <verify>npx tsc --noEmit | grep -i "monitoring.ts" returns no errors</verify>
  <done>recordErrorのcontextパラメータが適切な型制約を持っている</done>
</task>

<task type="auto">
  <name>Task 5: lib/share.tsのany型を修正</name>
  <files>mobile/src/lib/share.ts</files>
  <action>
    shareNative関数内のerror型を`any`から`unknown`に変更。
    1. `error: any`を`error: unknown`に変更
    2. 型ガード`error instanceof Error`を追加して安全にプロパティアクセス
  </action>
  <verify>npx tsc --noEmit | grep -i "share.ts" returns no errors</verify>
  <done>errorがunknown型で適切に型ガードされている</done>
</task>

<task type="auto">
  <name>Task 6: lib/storage/migrations.tsのany型を修正</name>
  <files>mobile/src/lib/storage/migrations.ts</files>
  <action>
    migrateStorage関数のoldDataパラメータとvalidateSchema関数のdataパラメータを`any`から`unknown`に変更。
    1. `oldData: any`を`oldData: unknown`に変更
    2. 関数内で型ガードを使用して安全に型チェック
    3. validateSchemaのdataパラメータも同様に変更
  </action>
  <verify>npx tsc --noEmit | grep -i "migrations.ts" returns no errors</verify>
  <done>migrateStorageとvalidateSchemaがunknown型で適切に型ガードされている</done>
</task>

<task type="auto">
  <name>Task 7: lib/notifications.tsの型エラーを修正</name>
  <files>mobile/src/lib/notifications.ts</files>
  <action>
    expo-notificationsのDateTriggerInput型エラーを修正。
    1. trigger.typeを"SchedulableTriggerInputTypes.DATE"または適切なリテラル型に変更
    2. channelIdプロパティの位置を修正（DateTriggerInputにはchannelIdは含まれない）
    3. contentのtriggerプロパティを正しく構成
  </action>
  <verify>npx tsc --noEmit | grep -i "notifications.ts" returns no errors</verify>
  <done>notifications.tsの型エラーが解消されている</done>
</task>

<task type="auto">
  <name>Task 8: components/cards/*のcharacterName型エラーを修正</name>
  <files>
    mobile/src/components/cards/FamilyCard.tsx
    mobile/src/components/cards/LoveCard.tsx
    mobile/src/components/cards/WorkCard.tsx
  </files>
  <action>
    FamilyCard、LoveCard、WorkCardでcharacterNameプロパティへのアクセスエラーを修正。
    1. ViralCharacterData型をdata/viral-characters.tsからimport
    2. 各カードでcharacterNameを使用する前に、適切なデータ取得処理を確認
    3. 型定義と実際のデータ構造を整合させる
  </action>
  <verify>npx tsc --noEmit | grep -E "(FamilyCard|LoveCard|WorkCard)" returns no errors</verify>
  <done>カードコンポーネントのcharacterNameアクセスで型エラーが発生しない</done>
</task>

<task type="auto">
  <name>Task 9: app/settings.tsxの型エラーを修正</name>
  <files>mobile/app/settings.tsx</files>
  <action>
    UsageCounts型のcompatibilityプロパティ型エラーを修正。
    1. stateの型定義でcompatibilityを`string[]`として正しく定義
    2. UsageCounts型が正しくエクスポートされていることを確認
    3. 型の不一致を解消
  </action>
  <verify>npx tsc --noEmit | grep -i "settings.tsx" returns no errors</verify>
  <done>settings.tsxの型エラーが解消されている</done>
</task>

<task type="auto">
  <name>Task 10: 全体のTypeScript型チェックを実行</name>
  <files>mobile/tsconfig.json</files>
  <action>
    `npx tsc --noEmit`を実行し、全ての型エラーが解消されていることを確認。
    エラーがある場合は、各ファイルを修正してエラーを0にする。
  </action>
  <verify>npx tsc --noEmit exits with code 0 and no errors</verify>
  <done>TypeScript strict mode下で型エラーが発生しない状態</done>
</task>

</tasks>

<verification>
1. `cd mobile && npx tsc --noEmit` がエラーなしで完了すること
2. `any`型の使用が9ファイルから17箇所→0箇所に削減されていること
3. ビルド`npm run ios`または`npm run android`がTypeScriptエラーなく開始できること
</verification>

<success_criteria>
1. TypeScript strict mode有効状態で型エラー数: 0
2. `any`型使用箇所: 0（unknownまたは適切な型に置換）
3. ビルドがTypeScriptエラーなしで通過する
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-code-quality/01-01-SUMMARY.md`
</output>
