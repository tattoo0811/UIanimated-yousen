---
phase: 10-friend-compatibility
plan: 02
type: execute
wave: 2
depends_on: ['10-01']
files_modified:
  - mobile/src/components/cards/CompatibilityCard.tsx
  - mobile/src/screens/CompatibilityResultScreen.tsx
  - backend/src/compositions/CompatibilityComposition.tsx
  - backend/src/api/routes/compatibility.ts
autonomous: false

must_haves:
  truths:
    - "User can add multiple friends (2-10) and compare compatibility"
    - "Compatibility scores displayed with visual indicators (colors, icons)"
    - "Results can be shared as video with compatibility highlights"
    - "Video generation includes multi-person comparison visuals"
    - "Mobile UI shows both pairwise and group comparison results"
  artifacts:
    - path: "mobile/src/components/cards/CompatibilityCard.tsx"
      provides: "Multi-person comparison UI"
      min_lines: 200
    - path: "mobile/src/screens/CompatibilityResultScreen.tsx"
      provides: "Detailed compatibility results with video generation"
      min_lines: 150
    - path: "backend/src/compositions/CompatibilityComposition.tsx"
      provides: "Remotion composition for compatibility video"
      min_lines: 120
    - path: "backend/src/api/routes/compatibility.ts"
      provides: "Enhanced API with video generation support"
      exports: ["POST /api/compatibility/calculate", "POST /api/compatibility/video"]
  key_links:
    - from: "mobile/src/components/cards/CompatibilityCard.tsx"
      to: "backend/src/api/routes/compatibility.ts"
      via: "fetch('/api/compatibility/calculate')"
      pattern: "fetch.*compatibility"
    - from: "mobile/src/screens/CompatibilityResultScreen.tsx"
      to: "backend/src/api/controllers/renderController.ts"
      via: "triggerRender for compatibility video"
      pattern: "triggerRender"
    - from: "backend/src/compositions/CompatibilityComposition.tsx"
      to: "backend/src/lib/compatibilityCalculator.ts"
      via: "Use compatibility calculation for video content"
      pattern: "calculateCompatibility"
---

<objective>
Create mobile UI for multi-person friend compatibility comparison with shareable video generation.

Purpose: Enable users to compare compatibility with multiple friends (2-10 people) and generate shareable videos highlighting compatibility scores, making the results viral-worthy.

Output: Enhanced CompatibilityCard with multi-person support, new results screen with video generation, and backend Remotion composition for compatibility videos.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-friend-compatibility/10-01-SUMMARY.md

# Reference existing mobile patterns
@mobile/src/components/cards/CompatibilityCard.tsx
@mobile/src/components/SwipeableStack.tsx

# Reference video generation patterns
@backend/src/compositions/HookComposition.tsx
@backend/src/api/controllers/renderController.ts

# Reference existing card patterns for consistency
@mobile/src/components/cards/FamilyCard.tsx
@mobile/src/components/cards/LoveCard.tsx
@mobile/src/components/cards/WorkCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Enhance CompatibilityCard for multi-person support</name>
  <files>mobile/src/components/cards/CompatibilityCard.tsx</files>
  <action>
Update existing CompatibilityCard.tsx to support 2-10 people comparison:

Key changes:
1. Change max partners from 3 to 10
2. Add group comparison mode for 3+ people
3. Display compatibility matrix for 3+ people
4. Integrate with backend API from 10-01
5. Maintain existing UI patterns (saved partners, add new, result display)

```typescript
// Add new state for group comparison
const [comparisonMode, setComparisonMode] = useState<'pairwise' | 'group'>('pairwise');
const [groupResults, setGroupResults] = useState<MultiPersonComparison | null>(null);

// Update saveAndDiagnose to allow up to 10 people
const saveAndDiagnose = async () => {
  if (savedPartners.length >= 10) return; // Changed from 3 to 10
  // ... existing logic
};

// Add fetch from backend API
const calculateWithBackend = async () => {
  try {
    const response = await fetch('https://backend-url/api/compatibility/calculate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        people: [
          { name: '„ÅÇ„Å™„Åü', birthDate: myBirthDate, gender: myGender },
          ...savedPartners.map(p => ({
            name: p.name,
            birthDate: `${p.year}-${p.month}-${p.day}`,
            gender: 'female', // Default or add gender input
          })),
        ],
      }),
    });
    const data = await response.json();

    if (savedPartners.length === 1) {
      setCompatibility(data); // Existing pairwise result
    } else {
      setGroupResults(data); // New group comparison
    }
  } catch (error) {
    console.error('API error:', error);
    // Fallback to local calculation
  }
};

// Add group comparison display section
{groupResults && (
  <View className="mb-4">
    <Text className="text-xl font-bold mb-2">„Ç∞„É´„Éº„ÉóÁõ∏ÊÄß„É©„É≥„Ç≠„É≥„Ç∞</Text>
    {groupResults.rankings.map((ranking, index) => (
      <View key={index} className="flex-row justify-between items-center py-2 border-b">
        <Text className="font-bold">{index + 1}. {ranking.person}</Text>
        <View className="flex-row items-center gap-2">
          <Text className="text-lg font-bold">{ranking.averageScore}ÁÇπ</Text>
          <Text className="text-sm text-gray-600">
            „Éô„Çπ„Éà: {ranking.bestMatch} ({ranking.bestMatchScore}ÁÇπ)
          </Text>
        </View>
      </View>
    ))}
  </View>
)}
```

Keep existing:
- Saved partners display
- Add new partner UI
- Pairwise result display for 2 people
- Styling and animations

Add:
- Group comparison results for 3+ people
- Backend API integration
- "Generate Video" button in results
  </action>
  <verify>
Check: TypeScript compilation succeeds
Check: Existing pairwise functionality still works
Check: New group comparison displays for 3+ people
  </verify>
  <done>
CompatibilityCard enhanced to support 2-10 people with both pairwise and group comparison modes. Backend API integrated for calculations.
  </done>
</task>

<task type="auto">
  <name>Create compatibility result screen with video generation</name>
  <files>mobile/src/screens/CompatibilityResultScreen.tsx</files>
  <action>
Create new screen for detailed compatibility results with video generation:

```typescript
import { View, Text, ScrollView, TouchableOpacity, ActivityIndicator } from 'react-native';
import { useState } from 'react';
import { Share, VideoView, useVideo } from 'expo-video';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { triggerRender } from '@/src/lib/api/video'; // Import from existing video API

type CompatibilityResultScreenParams = {
  result: string; // JSON stringified compatibility result
  people: string; // JSON stringified people array
};

export default function CompatibilityResultScreen() {
  const router = useRouter();
  const params = useLocalSearchParams<CompatibilityResultScreenParams>();
  const result = params.result ? JSON.parse(params.result) : null;
  const people = params.people ? JSON.parse(params.people) : [];

  const [videoUrl, setVideoUrl] = useState<string | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const generateVideo = async () => {
    setIsGenerating(true);
    try {
      const renderResult = await triggerRender({
        composition: 'CompatibilityComposition',
        inputProps: {
          people,
          compatibilityResult: result,
          theme: 'KiraPop', // Or user's selected theme
          tone: 'TikTok', // Or user's selected tone
        },
      });

      // Poll for completion (existing pattern from Phase 6)
      // ... poll logic
      setVideoUrl(finalVideoUrl);
    } catch (error) {
      console.error('Video generation failed:', error);
    } finally {
      setIsGenerating(false);
    }
  };

  const shareVideo = async () => {
    if (!videoUrl) return;
    // Use existing share logic from Phase 6
    // ... share implementation
  };

  return (
    <ScrollView className="flex-1 bg-white">
      {/* Header */}
      <View className="p-4 border-b">
        <Text className="text-2xl font-black">Áõ∏ÊÄßË®∫Êñ≠ÁµêÊûú üíï</Text>
      </View>

      {/* Overall Score */}
      <View className="p-6 items-center">
        <Text className="text-7xl font-black">{result.scores.overall}</Text>
        <Text className="text-2xl font-bold mt-2">{result.message}</Text>
      </View>

      {/* Aspect Scores */}
      <View className="px-4 mb-4">
        <Text className="text-lg font-bold mb-2">Áõ∏ÊÄßË©≥Á¥∞</Text>
        {[
          { label: 'ÊÅãÊÑõ', score: result.scores.love, icon: 'üíï' },
          { label: '‰ªï‰∫ã', score: result.scores.work, icon: 'üíº' },
          { label: 'ÂèãÊÉÖ', score: result.scores.friendship, icon: 'ü§ù' },
        ].map((aspect) => (
          <View key={aspect.label} className="flex-row items-center py-2">
            <Text className="text-2xl mr-3">{aspect.icon}</Text>
            <Text className="flex-1 font-bold">{aspect.label}</Text>
            <Text className="font-bold text-lg">{aspect.score}ÁÇπ</Text>
          </View>
        ))}
      </View>

      {/* Advice */}
      <View className="mx-4 p-4 bg-blue-50 rounded-xl mb-4">
        <Text className="font-bold mb-2">„Ç¢„Éâ„Éê„Ç§„Çπ üí°</Text>
        <Text className="text-sm">{result.advice}</Text>
      </View>

      {/* Video Preview */}
      {videoUrl && (
        <View className="mx-4 mb-4">
          <VideoView
            source={{ uri: videoUrl }}
            style={{ width: '100%', aspectRatio: 9/16, borderRadius: 12 }}
            nativeControls
          />
        </View>
      )}

      {/* Action Buttons */}
      <View className="p-4 gap-2">
        {!videoUrl ? (
          <TouchableOpacity
            onPress={generateVideo}
            disabled={isGenerating}
            className="bg-[#FF7E5F] p-4 rounded-xl items-center"
          >
            {isGenerating ? (
              <ActivityIndicator color="#fff" />
            ) : (
              <Text className="text-white font-bold text-lg">ÂãïÁîª„ÇíÁîüÊàê üé¨</Text>
            )}
          </TouchableOpacity>
        ) : (
          <TouchableOpacity
            onPress={shareVideo}
            className="bg-[#60A5FA] p-4 rounded-xl items-center"
          >
            <Text className="text-white font-bold text-lg">„Ç∑„Çß„Ç¢ üì§</Text>
          </TouchableOpacity>
        )}

        <TouchableOpacity
          onPress={() => router.back()}
          className="bg-gray-200 p-4 rounded-xl items-center"
        >
          <Text className="font-bold">Êàª„Çã</Text>
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
}
```

Key features:
1. Display overall compatibility score prominently
2. Show aspect-specific scores (love/work/friendship)
3. Display advice text
4. Video generation button using existing render API
5. Video preview and share using Phase 6 patterns
6. Navigation back to previous screen
  </action>
  <verify>
Check: Screen file created and exported
Check: TypeScript compilation succeeds
Check: All imports are valid (video API, navigation)
  </verify>
  <done>
CompatibilityResultScreen created with detailed score display, video generation integration, and share functionality.
  </done>
</task>

<task type="auto">
  <name>Create compatibility video composition</name>
  <files>backend/src/compositions/CompatibilityComposition.tsx</files>
  <action>
Create Remotion composition for compatibility video:

```typescript
import { Composition, interpolate, useCurrentFrame, useVideoConfig, AbsoluteFill } from 'remotion';
import { useEffect, useState } from 'react';
import { useTheme } from '../themes/useTheme';
import { TypingText } from './TypingText';
import { VideoTemplate } from './VideoTemplate';
import type { CompatibilityResult } from '../types/compatibility';

interface CompatibilityCompositionProps {
  people: Array<{ name: string; birthDate: string; gender: 'male' | 'female' }>;
  compatibilityResult: CompatibilityResult;
  theme: 'KiraPop' | 'MonoEdge' | 'ZenWa';
  tone: 'TikTok' | 'YouTube' | 'Instagram';
}

export const CompatibilityComposition: React.FC<CompatibilityCompositionProps> = ({
  people,
  compatibilityResult,
  theme,
  tone,
}) => {
  const themeConfig = useTheme(theme);
  const frame = useCurrentFrame();
  const { fps } = useVideoConfig();

  const [section, setSection] = useState(0);

  // Section timing (frames)
  const SECTIONS = {
    hook: 90,      // 0-3s
    intro: 150,    // 3-5s
    score: 270,    // 5-9s
    aspects: 420,  // 9-14s
    advice: 570,   // 14-19s
    cta: 720,      // 19-24s
    branding: 900, // 24-30s
  };

  useEffect(() => {
    if (frame < SECTIONS.hook) setSection(0);
    else if (frame < SECTIONS.intro) setSection(1);
    else if (frame < SECTIONS.score) setSection(2);
    else if (frame < SECTIONS.aspects) setSection(3);
    else if (frame < SECTIONS.advice) setSection(4);
    else if (frame < SECTIONS.cta) setSection(5);
    else setSection(6);
  }, [frame]);

  const person1 = people[0]?.name || '„ÅÇ„Å™„Åü';
  const person2 = people[1]?.name || 'Áõ∏Êâã';

  return (
    <AbsoluteFill style={{ backgroundColor: themeConfig.colors.background }}>
      <VideoTemplate theme={theme}>
        {/* Section 0: Hook (0-3s) */}
        {section === 0 && (
          <AbsoluteFill style={{ justifyContent: 'center', alignItems: 'center' }}>
            <Text
              style={{
                fontSize: 80,
                fontWeight: 'black',
                color: themeConfig.colors.primary,
                opacity: interpolate(frame, [0, 30], [0, 1]),
                transform: `scale(${interpolate(frame, [0, 60], [0.5, 1])})`,
              }}
            >
              üíï
            </Text>
            <Text
              style={{
                fontSize: 48,
                fontWeight: 'black',
                color: themeConfig.colors.text,
                marginTop: 20,
                opacity: interpolate(frame, [30, 60], [0, 1]),
              }}
            >
              {person1} √ó {person2}
            </Text>
            <Text
              style={{
                fontSize: 36,
                fontWeight: 'bold',
                color: themeConfig.colors.accent,
                marginTop: 10,
                opacity: interpolate(frame, [60, 90], [0, 1]),
              }}
            >
              Áõ∏ÊÄßË®∫Êñ≠
            </Text>
          </AbsoluteFill>
        )}

        {/* Section 1: Intro (3-5s) */}
        {section >= 1 && (
          <AbsoluteFill style={{ top: '40%', alignItems: 'center' }}>
            <TypingText
              text={`${person1}„Å®${person2}„ÅÆ\nÁõ∏ÊÄß„ÇíË®∫Êñ≠„Åó„Åæ„Åô...`}
              style={{
                fontSize: 42,
                fontWeight: 'bold',
                color: themeConfig.colors.text,
                textAlign: 'center',
              }}
              speed={themeConfig.typing.speed}
              startFrame={SECTIONS.hook}
            />
          </AbsoluteFill>
        )}

        {/* Section 2: Score (5-9s) */}
        {section >= 2 && (
          <AbsoluteFill style={{ top: '35%', alignItems: 'center' }}>
            <Text
              style={{
                fontSize: 140,
                fontWeight: 'black',
                color: themeConfig.colors.primary,
                opacity: interpolate(frame, [SECTIONS.intro, SECTIONS.intro + 30], [0, 1]),
              }}
            >
              {compatibilityResult.scores.overall}
            </Text>
            <TypingText
              text={compatibilityResult.message}
              style={{
                fontSize: 48,
                fontWeight: 'bold',
                color: themeConfig.colors.text,
                textAlign: 'center',
                marginTop: 20,
              }}
              speed={themeConfig.typing.speed}
              startFrame={SECTIONS.intro + 30}
            />
          </AbsoluteFill>
        )}

        {/* Section 3: Aspects (9-14s) */}
        {section >= 3 && (
          <AbsoluteFill style={{ top: '30%', paddingHorizontal: 60 }}>
            {[
              { label: 'ÊÅãÊÑõ', score: compatibilityResult.scores.love, icon: 'üíï' },
              { label: '‰ªï‰∫ã', score: compatibilityResult.scores.work, icon: 'üíº' },
              { label: 'ÂèãÊÉÖ', score: compatibilityResult.scores.friendship, icon: 'ü§ù' },
            ].map((aspect, index) => {
              const startFrame = SECTIONS.score + index * 45;
              const opacity = interpolate(
                frame,
                [startFrame, startFrame + 30],
                [0, 1],
                { extrapolateRight: 'clamp' }
              );
              const translateX = interpolate(
                frame,
                [startFrame, startFrame + 30],
                [50, 0],
                { extrapolateRight: 'clamp' }
              );

              return (
                <View
                  key={aspect.label}
                  style={{
                    flexDirection: 'row',
                    alignItems: 'center',
                    marginBottom: 30,
                    opacity,
                    transform: `translateX(${translateX}px)`,
                  }}
                >
                  <Text style={{ fontSize: 48, marginRight: 20 }}>{aspect.icon}</Text>
                  <View style={{ flex: 1 }}>
                    <Text style={{
                      fontSize: 36,
                      fontWeight: 'bold',
                      color: themeConfig.colors.text,
                    }}>
                      {aspect.label}
                    </Text>
                    <View style={{
                      height: 20,
                      backgroundColor: '#e5e5e5',
                      borderRadius: 10,
                      overflow: 'hidden',
                      marginTop: 10,
                    }}>
                      <View
                        style={{
                          width: `${aspect.score}%`,
                          height: '100%',
                          backgroundColor: themeConfig.colors.primary,
                        }}
                      />
                    </View>
                  </View>
                  <Text style={{
                    fontSize: 42,
                    fontWeight: 'black',
                    color: themeConfig.colors.primary,
                    marginLeft: 20,
                  }}>
                    {aspect.score}
                  </Text>
                </View>
              );
            })}
          </AbsoluteFill>
        )}

        {/* Section 4: Advice (14-19s) */}
        {section >= 4 && (
          <AbsoluteFill style={{ top: '40%', paddingHorizontal: 60 }}>
            <TypingText
              text={compatibilityResult.advice}
              style={{
                fontSize: 36,
                fontWeight: 'bold',
                color: themeConfig.colors.text,
                textAlign: 'center',
                lineHeight: 1.5,
              }}
              speed={themeConfig.typing.speed}
              startFrame={SECTIONS.aspects}
            />
          </AbsoluteFill>
        )}

        {/* Section 5: CTA (19-24s) */}
        {section >= 5 && (
          <AbsoluteFill style={{ justifyContent: 'center', alignItems: 'center' }}>
            <Text
              style={{
                fontSize: 48,
                fontWeight: 'black',
                color: themeConfig.colors.text,
                opacity: interpolate(frame, [SECTIONS.advice, SECTIONS.advice + 30], [0, 1]),
              }}
            >
              ÂèãÈÅî„Å®„ÇÇË®∫Êñ≠„Åó„Å¶„Åø„Çà„ÅÜÔºÅ
            </Text>
            <Text
              style={{
                fontSize: 36,
                fontWeight: 'bold',
                color: themeConfig.colors.primary,
                marginTop: 20,
                opacity: interpolate(frame, [SECTIONS.advice + 30, SECTIONS.advice + 60], [0, 1]),
              }}
            >
              üëá
            </Text>
          </AbsoluteFill>
        )}

        {/* Section 6: Branding (24-30s) */}
        {section >= 6 && (
          <AbsoluteFill style={{ justifyContent: 'center', alignItems: 'center' }}>
            <Text
              style={{
                fontSize: 42,
                fontWeight: 'bold',
                color: themeConfig.colors.text,
                opacity: interpolate(frame, [SECTIONS.cta, SECTIONS.cta + 30], [0, 1]),
              }}
            >
              Èô∞ÈôΩ‰∫îË°å„Ç¢„Éó„É™
            </Text>
          </AbsoluteFill>
        )}
      </VideoTemplate>
    </AbsoluteFill>
  );
};

// Schema for validation
export const compatibilityCompositionSchema = {
  people: {
    type: 'array-of-objects',
    required: true,
  },
  compatibilityResult: {
    type: 'object',
    required: true,
  },
  theme: {
    type: 'enum',
    values: ['KiraPop', 'MonoEdge', 'ZenWa'],
    required: true,
  },
  tone: {
    type: 'enum',
    values: ['TikTok', 'YouTube', 'Instagram'],
    required: true,
  },
};
```

Then register in backend/src/index.tsx:
```typescript
import { CompatibilityComposition } from './compositions/CompatibilityComposition';

<Composition
  id="CompatibilityComposition"
  component={CompatibilityComposition as any}
  durationInFrames={900}
  fps={30}
  width={1080}
  height={1920}
  defaultProps={{
    people: [{ name: '„ÅÇ„Å™„Åü', birthDate: '1990-01-01', gender: 'female' }],
    compatibilityResult: { scores: { overall: 85, love: 90, work: 80, friendship: 85 }, level: 'great', message: 'Á¥†Êô¥„Çâ„Åó„ÅÑÁõ∏ÊÄßÔºÅ', advice: '„Åä‰∫í„ÅÑ„ÇíÈ´ò„ÇÅÂêà„Åà„ÇãÈñ¢‰øÇ„Åß„Åô„ÄÇ' },
    theme: 'KiraPop',
    tone: 'TikTok',
  }}
/>
```

Then add video generation route to backend/src/api/routes/compatibility.ts:
```typescript
router.post('/video', async (req, res) => {
  try {
    const { people, compatibilityResult, theme, tone } = req.body;

    const renderResult = await triggerRender({
      composition: 'CompatibilityComposition',
      inputProps: { people, compatibilityResult, theme, tone },
    });

    res.json({
      jobId: renderResult.jobId,
      status: renderResult.status,
    });
  } catch (error) {
    res.status(500).json({ error: 'Failed to generate video' });
  }
});
```

Key features:
1. 7-section structure: Hook ‚Üí Intro ‚Üí Score ‚Üí Aspects ‚Üí Advice ‚Üí CTA ‚Üí Branding
2. Theme integration (KiraPop, MonoEdge, ZenWa)
3. TypingText for dynamic text reveal
4. Smooth animations using interpolate
5. Aspect bars with fill animation
6. Optimized for 9:16 vertical video format
  </action>
  <verify>
Run: npx tsc --noEmit in backend/
Check: Composition registered in index.tsx
Check: Route added to compatibility.ts
  </verify>
  <done>
CompatibilityComposition created with 7-section video structure, theme integration, and API route for video generation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete multi-person compatibility feature:
1. Enhanced CompatibilityCard with 2-10 person support
2. New CompatibilityResultScreen with detailed scores and video generation
3. CompatibilityComposition for shareable compatibility videos
4. Backend API integration for calculations and video generation
  </what-built>
  <how-to-verify>
1. Open mobile app, navigate to compatibility card
2. Add 2-3 friends with birthdates
3. View compatibility results (pairwise for 2, group rankings for 3+)
4. Tap "Generate Video" button
5. Verify video generation completes (check backend logs if needed)
6. View generated video preview
7. Test share functionality
8. Verify video displays:
   - People names
   - Overall compatibility score
   - Aspect scores (love/work/friendship) with animated bars
   - Advice text
   - CTA and branding sections
  </how-to-verify>
  <resume-signal>
Type "approved" if everything works, or describe any issues to fix.
  </resume-signal>
</task>

</tasks>

<verification>
Manual verification through mobile app testing as described in checkpoint task.
</verification>

<success_criteria>
1. Multi-person comparison (2-10 people) works correctly
2. Backend compatibility calculations return consistent results
3. Video generation produces compatibility videos with all sections
4. Generated videos are shareable through existing share flow
5. UI follows existing design patterns (colors, animations, typography)
</success_criteria>

<output>
After completion, create `.planning/phases/10-friend-compatibility/10-02-SUMMARY.md`
</output>
