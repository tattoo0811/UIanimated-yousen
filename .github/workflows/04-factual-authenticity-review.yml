name: factual-authenticity-review

on:
  push:
    branches: ['**']
    paths:
      - 'novel/**/*.md'
      - 'meguru-storyline-v3.md'
      - 'tools/**/*.ts'
      - 'claudedocs/**/*'
  pull_request:
    paths:
      - 'novel/**/*.md'
      - 'meguru-storyline-v3.md'
      - 'tools/**/*.ts'
      - 'claudedocs/**/*'
  workflow_dispatch:

jobs:
  factual-authenticity:
    name: factual-authenticity-review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          cd tools && npm ci

      - name: å°‚é–€æ€§ãƒã‚§ãƒƒã‚¯
        id: authenticity
        run: |
          set +e
          OUTPUT=$(npx tsx tools/reviews/factual-authenticity.ts 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "$OUTPUT" > /tmp/authenticity-output.txt
          exit 0

      - name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/authenticity-output.txt', 'utf8');
            const exitCode = '${{ steps.authenticity.outputs.exit_code }}';
            const icon = exitCode === '0' ? 'âœ…' : 'ğŸ“š';

            const body = `## ${icon} å²å®Ÿãƒ»å°‚é–€æ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ### ãƒã‚§ãƒƒã‚¯é …ç›®
            - å æ˜Ÿè¡“ãƒ»å››æŸ±æ¨å‘½ã®å°‚é–€æ€§
            - æ­´å²çš„èƒŒæ™¯ã®æ­£ç¢ºæ€§
            - å“²å­¦ãƒ»å¿ƒç†å­¦å¼•ç”¨ã®å¦¥å½“æ€§
            - æœ±å­¦é™¢ã‚µã‚¤ãƒˆã¨ã®æ•´åˆæ€§

            ### çµæœ

            \`\`\`
            ${output}
            \`\`\

            > _æ‹…å½“: FactualAuthenticityReviewer_
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: å¤±æ•—æ™‚ã«ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã«ã™ã‚‹
        if: steps.authenticity.outputs.exit_code != '0'
        run: exit 1
