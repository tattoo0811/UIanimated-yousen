name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ãƒ¬ãƒ“ãƒ¥ãƒ¼

on:
  push:
    branches: ['**']
    paths:
      - 'novel/**/*.md'
      - 'meguru-storyline-v3.md'
      - 'claudedocs/active/character*.md'
  pull_request:
    paths:
      - 'novel/**/*.md'
      - 'meguru-storyline-v3.md'
      - 'claudedocs/active/character*.md'
  workflow_dispatch:

jobs:
  character-voice:
    name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å£°ã¨ç™ºè¨€ã®çŸ›ç›¾ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          cd tools && npm ci

      - name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ãƒã‚§ãƒƒã‚¯
        id: voice
        run: |
          set +e
          OUTPUT=$(npx tsx tools/reviews/character-voice.ts 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "$OUTPUT" > /tmp/voice-output.txt
          exit 0

      - name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/voice-output.txt', 'utf8');
            const exitCode = '${{ steps.voice.outputs.exit_code }}';
            const icon = exitCode === '0' ? 'âœ…' : 'ğŸ’¡';

            const body = `## ${icon} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ### ãƒã‚§ãƒƒã‚¯é …ç›®
            - ç™ºè¨€ã®çŸ›ç›¾ï¼ˆæ€§æ ¼ä¸€è²«æ€§ï¼‰
            - ã‚ˆã‚Šè‰¯ã„ã‚»ãƒªãƒ•ã®ææ¡ˆ
            - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã€Œå£°ã€ã®å“è³ªè©•ä¾¡
            - è¨€è‘‰é£ã„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ€§

            ### çµæœ

            \`\`\`
            ${output}
            \`\`\`

            > _æ‹…å½“: CharacterVoiceReviewer_
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: å¤±æ•—æ™‚ã«ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã«ã™ã‚‹
        if: steps.voice.outputs.exit_code != '0'
        run: exit 1
