#!/bin/bash

# ============================================================
# Pre-push Hook: Story Quality Checks (Hybrid)
# ============================================================
# ãƒ–ãƒ©ãƒ³ãƒã‚’ push ã™ã‚‹å‰ã«å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
#
# ãƒ¬ãƒ™ãƒ«1: è¡¨å±¤ãƒã‚§ãƒƒã‚¯ï¼ˆå¸¸æ™‚å®Ÿè¡Œï¼‰
#  - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼ (database-consistency)
#  - ç‰©èªæ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼ (story-coherence)
#  - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ãƒ¬ãƒ“ãƒ¥ãƒ¼ (character-voice)
#  - å²å®Ÿãƒ»å°‚é–€æ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼ (factual-authenticity)
#
# ãƒ¬ãƒ™ãƒ«2: æ·±ã„æ–‡è„ˆãƒã‚§ãƒƒã‚¯ï¼ˆnovelå¤‰æ›´æ™‚ææ¡ˆï¼‰
#  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ ã«ã‚ˆã‚‹AIãƒ¬ãƒ“ãƒ¥ãƒ¼
#  - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¿ƒç†çš„ä¸€è²«æ€§
#  - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®è«–ç†çŸ›ç›¾
#  - å°‚é–€ç”¨èªã®æ–‡è„ˆçš„æ­£ç¢ºã•
#
# ã‚¹ã‚­ãƒƒãƒ—: git push --no-verify
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ: git push --agent-review
# ============================================================

set -e

# è‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================
# novel ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œå‡º
# ============================================================

detect_novel_changes() {
  local current_branch=$(git rev-parse --abbrev-ref HEAD)
  local remote_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")

  # å¤‰æ›´ã•ã‚ŒãŸ novel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  local novel_files=$(git diff --name-only $remote_branch...HEAD | grep -E "^novel/.*\.md$" || true)

  if [ -n "$novel_files" ]; then
    local count=$(echo "$novel_files" | wc -l | tr -d ' ')
    echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${MAGENTA}  ğŸ“– Novel Files Changed: ${count} file(s)${NC}"
    echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "$novel_files" | while read file; do
      echo -e "  ${CYAN}â€¢${NC} ${file}"
    done
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Recommendation: Run AI agent review for deeper analysis${NC}"
    echo -e "${CYAN}   Command: git push --agent-review${NC}"
    echo -e "${CYAN}   Or manually: /glm-reviewer tools/reviews/story-quality-check.md${NC}"
    echo ""
    echo -e "${MAGENTA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # --agent-review ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ èµ·å‹•
    if [[ "$@" == *"--agent-review"* ]]; then
      echo -e "${BLUE}ğŸ¤– Starting AI agent team review...${NC}"
      echo ""

      # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if [ -f ".githooks/agent-review.sh" ]; then
        bash .githooks/agent-review.sh "$novel_files"
      else
        echo -e "${YELLOW}âš  Agent review script not found. Skipping...${NC}"
      fi
    fi
  fi
}

# ============================================================
# è¡¨å±¤ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
# ============================================================

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Story Quality Pre-push Checks (Level 1)${NC}"
echo -e "${BLUE}================================================${NC}"

# ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
ERRORS=0
CHECKS_PASSED=()

run_check() {
  local name=$1
  local script=$2

  echo ""
  echo -e "${BLUE}Checking: ${name}...${NC}"

  if npx tsx "${script}" 2>&1; then
    echo -e "${GREEN}âœ“ ${name}: PASSED${NC}"
    CHECKS_PASSED+=("${name}")
  else
    echo -e "${RED}âœ— ${name}: FAILED${NC}"
    ERRORS=$((ERRORS + 1))
  fi
}

# ============================================================
# ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
# ============================================================

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
if [ ! -d "tools/node_modules" ]; then
  echo -e "${YELLOW}âš  Installing dependencies...${NC}"
  cd tools && npm install >/dev/null 2>&1 && cd ..
fi

echo ""
echo -e "${BLUE}Running 4 quality checks...${NC}"

# 1. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼
run_check "ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§" "tools/reviews/database-consistency.ts"

# 2. ç‰©èªæ•´åˆæ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼
run_check "ç‰©èªæ•´åˆæ€§" "tools/reviews/story-coherence.ts"

# 3. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ãƒ¬ãƒ“ãƒ¥ãƒ¼
run_check "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾" "tools/reviews/character-voice.ts"

# 4. å²å®Ÿãƒ»å°‚é–€æ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼
run_check "å²å®Ÿãƒ»å°‚é–€æ€§" "tools/reviews/factual-authenticity.ts"

# ============================================================
# çµæœåˆ¤å®š
# ============================================================

echo ""
echo -e "${BLUE}================================================${NC}"

if [ $ERRORS -eq 0 ]; then
  echo -e "${GREEN}âœ“ All checks passed! (${#CHECKS_PASSED[@]}/4)${NC}"

  # novel ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º
  detect_novel_changes "$@"

  echo -e "${GREEN}Proceeding with push...${NC}"
  echo -e "${BLUE}================================================${NC}"
  exit 0
else
  echo -e "${RED}âœ— Push blocked: ${ERRORS} check(s) failed${NC}"
  echo ""
  echo -e "${YELLOW}Failed checks:${NC}"

  # å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯ã‚’è¡¨ç¤º
  ALL_CHECKS=("ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§" "ç‰©èªæ•´åˆæ€§" "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾" "å²å®Ÿãƒ»å°‚é–€æ€§")
  for check in "${ALL_CHECKS[@]}"; do
    if [[ ! " ${CHECKS_PASSED[@]} " =~ " ${check} " ]]; then
      echo -e "  ${RED}âœ—${NC} ${check}"
    fi
  done

  echo ""
  echo -e "${YELLOW}To skip these checks, use:${NC} git push --no-verify"
  echo -e "${BLUE}================================================${NC}"
  exit 1
fi
